<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¸“è¾‘è¯¦æƒ…</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">é›·æ£®éŸ³ä¹</div>
    <nav class="nav">
      <a href="/">æˆ‘çš„éŸ³ä¹</a>
      <a href="/artists">æ­Œæ‰‹</a>
      <a href="/albums">ä¸“è¾‘</a>
      <a href="/playlists">æˆ‘çš„æ­Œå•</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="æœç´¢æ­Œæ›²/æ­Œæ‰‹/ä¸“è¾‘" />
    </div>
  </header>

  <main class="album-page">
    <section class="album-info">
      <div class="disc">
        <div class="disc-cover" id="albumCover" style="background-image:url('https://picsum.photos/id/1015/300/300');"></div>
      </div>
      <div class="meta">
        <h1 id="albumTitle"></h1>
        <div class="tags">
          <span class="tag" id="albumArtist"></span>
          <span class="tag" id="songCount"></span>
        </div>
        <p class="artist">ä¸“è¾‘è¯¦æƒ…</p>

        <div class="actions">
          <button class="primary" id="playAllBtn">æ’­æ”¾å…¨éƒ¨</button>
          <button id="collectBtn">æ”¶è—</button>
          <button id="shareBtn">åˆ†äº«</button>
        </div>
      </div>
    </section>

    <section class="album-songs">
      <h2>æ­Œæ›²åˆ—è¡¨</h2>
      <div class="songs-list" id="songsList">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨æ’­æ”¾å™¨æ  -->
  <div class="player-bar">
    <div class="player-left">
      <img class="mini-cover" id="miniCover" src="https://picsum.photos/id/1062/60/60" alt="cover" />
      <div class="track">
        <div class="title" id="playerTitle"></div>
        <div class="artist" id="playerArtist"></div>
      </div>
    </div>
    <div class="player-center">
      <button id="prevBtn">â®</button>
      <button id="toggleBtn">â¯</button>
      <button id="nextBtn">â­</button>
    </div>
    <div class="player-right">
      <div class="time">
        <span id="curTime">00:00</span> / <span id="durTime">00:00</span>
      </div>
      <input id="progress" type="range" min="0" max="100" value="0" />
      <div class="volume-container">
        <span class="volume-icon" id="volumeIcon">ğŸ”Š</span>
        <input id="volume" type="range" min="0" max="100" value="80" />
      </div>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    // è·å–URLå‚æ•°
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        album: urlParams.get('album') || '',
        artist: urlParams.get('artist') || ''
      };
    }

    // åŠ è½½ä¸“è¾‘ä¿¡æ¯
    async function loadAlbumInfo() {
      const { album, artist } = getUrlParams();
      if (!album) {
        document.getElementById('albumTitle').textContent = 'ä¸“è¾‘ä¿¡æ¯åŠ è½½å¤±è´¥';
        return;
      }

      try {
        document.getElementById('albumTitle').textContent = album;
        document.getElementById('albumArtist').textContent = artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
        
        return { album, artist };
      } catch (error) {
        console.error('åŠ è½½ä¸“è¾‘ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('albumTitle').textContent = 'ä¸“è¾‘ä¿¡æ¯åŠ è½½å¤±è´¥';
      }
    }

    // åŠ è½½ä¸“è¾‘æ­Œæ›²åˆ—è¡¨
    async function loadAlbumSongs() {
      const { album, artist } = getUrlParams();
      if (!album) return;

      try {
        const response = await fetch(`/api/album_tracks?album=${encodeURIComponent(album)}&artist=${encodeURIComponent(artist)}`);
        if (!response.ok) throw new Error('æ­Œæ›²åˆ—è¡¨åŠ è½½å¤±è´¥');
        const songs = await response.json();
        
        const songsList = document.getElementById('songsList');
        if (songs.length === 0) {
          songsList.innerHTML = '<div class="no-results">è¯¥ä¸“è¾‘æš‚æ— æ­Œæ›²</div>';
          return;
        }
        
        // æ›´æ–°æ­Œæ›²æ•°é‡
        document.getElementById('songCount').textContent = `${songs.length}é¦–æ­Œæ›²`;
        
        // è®¾ç½®ä¸“è¾‘å°é¢ï¼ˆä½¿ç”¨ç¬¬ä¸€é¦–æ­Œæ›²çš„å°é¢ï¼‰
        if (songs.length > 0) {
          const coverEl = document.getElementById('albumCover');
          coverEl.style.backgroundImage = `url('/api/cover?id=${songs[0].id}')`;
        }
        
        // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
        songsList.innerHTML = renderSongsList(songs);
        
        // æ·»åŠ æ­Œæ›²ç‚¹å‡»äº‹ä»¶
        addSongClickEvents(songs);
        
        return songs;
      } catch (error) {
        console.error('åŠ è½½æ­Œæ›²åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('songsList').innerHTML = '<div class="no-results">æ­Œæ›²åˆ—è¡¨åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
    function renderSongsList(songs) {
      return `
        <div class="songs-container">
          ${songs.map((song, index) => `
            <div class="song-item" data-song-id="${song.id}">
              <span class="song-index">${index + 1}</span>
              <div class="song-info">
                <div class="song-title">${song.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
                <div class="song-album">${song.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</div>
              </div>
              <div class="song-actions">
                <button class="play-btn" data-song-id="${song.id}">æ’­æ”¾</button>
                <button class="collect-btn">æ”¶è—</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // æ·»åŠ æ­Œæ›²ç‚¹å‡»äº‹ä»¶
    function addSongClickEvents(songs) {
      // æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.play-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const songId = btn.dataset.songId;
          playSong(songId, songs);
        });
      });
      
      // æ­Œæ›²é¡¹ç‚¹å‡»äº‹ä»¶ï¼ˆæ•´è¡Œç‚¹å‡»æ’­æ”¾ï¼‰
      document.querySelectorAll('.song-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('play-btn') && !e.target.classList.contains('collect-btn')) {
            const songId = item.dataset.songId;
            playSong(songId, songs);
          }
        });
      });
    }

    // æ’­æ”¾å™¨æ§åˆ¶å˜é‡
    let currentPlaylist = [];
    let currentIndex = -1;

    // æ’­æ”¾æ­Œæ›²
    async function playSong(songId, playlist) {
      try {
        // è·å–æ­Œæ›²ä¿¡æ¯
        const response = await fetch(`/api/track?id=${songId}`);
        if (!response.ok) throw new Error('æ­Œæ›²ä¿¡æ¯åŠ è½½å¤±è´¥');
        const song = await response.json();
        
        // è®¾ç½®éŸ³é¢‘æº
        const audio = document.getElementById('audio');
        audio.src = `/api/audio?id=${songId}`;
        
        // æ›´æ–°æ’­æ”¾å™¨ä¿¡æ¯
        document.getElementById('playerTitle').textContent = song.title || 'æœªçŸ¥æ ‡é¢˜';
        document.getElementById('playerArtist').textContent = song.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
        document.getElementById('miniCover').src = `/api/cover?id=${songId}`;
        
        // æ’­æ”¾
        await audio.play();
        
        // è®¾ç½®å½“å‰æ’­æ”¾åˆ—è¡¨å’Œç´¢å¼•
        currentPlaylist = playlist;
        currentIndex = currentPlaylist.findIndex(track => track.id == songId);
        
      } catch (error) {
        console.error('æ’­æ”¾æ­Œæ›²å¤±è´¥:', error);
        alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // æ’­æ”¾å…¨éƒ¨
    document.getElementById('playAllBtn').addEventListener('click', async () => {
      const { album, artist } = getUrlParams();
      try {
        const response = await fetch(`/api/album_tracks?album=${encodeURIComponent(album)}&artist=${encodeURIComponent(artist)}`);
        if (!response.ok) throw new Error('æ­Œæ›²åˆ—è¡¨åŠ è½½å¤±è´¥');
        const songs = await response.json();
        
        if (songs.length > 0) {
          // æ’­æ”¾ç¬¬ä¸€é¦–æ­Œæ›²
          playSong(songs[0].id, songs);
        }
      } catch (error) {
        console.error('æ’­æ”¾å…¨éƒ¨å¤±è´¥:', error);
      }
    });

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // åŠ è½½ä¸“è¾‘ä¿¡æ¯å’Œæ­Œæ›²åˆ—è¡¨
      await loadAlbumInfo();
      const songs = await loadAlbumSongs();
      
      // åˆå§‹åŒ–æ’­æ”¾å™¨æ§åˆ¶
      initPlayerControls();
    });

    // æ’­æ”¾å™¨æ§åˆ¶åˆå§‹åŒ–
    function initPlayerControls() {
      const audio = document.getElementById('audio');
      const toggleBtn = document.getElementById('toggleBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progress = document.getElementById('progress');
      const volume = document.getElementById('volume');
      const curTime = document.getElementById('curTime');
      const durTime = document.getElementById('durTime');

      // æ’­æ”¾/æš‚åœ
      toggleBtn.addEventListener('click', async () => {
        if (audio.paused) {
          await audio.play();
        } else {
          audio.pause();
        }
      });

      // ä¸Šä¸€é¦–
      prevBtn.addEventListener('click', () => {
        if (currentPlaylist.length > 0 && currentIndex > 0) {
          currentIndex--;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });

      // ä¸‹ä¸€é¦–
      nextBtn.addEventListener('click', () => {
        if (currentPlaylist.length > 0 && currentIndex < currentPlaylist.length - 1) {
          currentIndex++;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });

      // è¿›åº¦æ¡æ§åˆ¶
      let isSeeking = false;
      progress.addEventListener('input', () => {
        if (isFinite(audio.duration)) {
          const value = Number(progress.value) || 0;
          audio.currentTime = value;
        }
      });

      progress.addEventListener('mousedown', () => { isSeeking = true; });
      progress.addEventListener('mouseup', () => { isSeeking = false; });

      // éŸ³é‡æ§åˆ¶
      volume.addEventListener('input', () => {
        audio.volume = volume.value / 100;
      });

      // æ—¶é—´æ›´æ–°
      audio.addEventListener('timeupdate', () => {
        curTime.textContent = formatTime(audio.currentTime);
        if (!isSeeking && isFinite(audio.duration)) {
          progress.value = Math.floor(audio.currentTime);
        }
      });

      audio.addEventListener('loadedmetadata', () => {
        if (isFinite(audio.duration)) {
          durTime.textContent = formatTime(audio.duration);
          progress.max = Math.floor(audio.duration);
        }
      });

      // æ­Œæ›²æ’­æ”¾ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–
      audio.addEventListener('ended', () => {
        if (currentPlaylist.length > 0 && currentIndex < currentPlaylist.length - 1) {
          currentIndex++;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>