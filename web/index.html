<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>äº‘éŸ³ä¹ - é¦–é¡µ</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">é›·æ£®éŸ³ä¹</div>
    <nav class="nav">
      <a href="/">æˆ‘çš„éŸ³ä¹</a>
      <a href="/artists">æ­Œæ‰‹</a>
      <a href="/albums">ä¸“è¾‘</a>
      <a href="/favorites">æˆ‘çš„æ”¶è—</a>
      <a href="/upload">ä¸Šä¼ </a>
      <a href="/forum">éŸ³ä¹è®ºå›</a>
      <a href="/profile">ä¸ªäººä¸­å¿ƒ</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="æœç´¢æ­Œæ›²/æ­Œæ‰‹/ä¸“è¾‘" />
    </div>
    <div class="user-actions">
      <button class="primary">åˆ›å»ºæ­Œå•</button>
      <button id="logoutBtn" class="hidden">é€€å‡º</button>
      <span id="userNickname" class="hidden nickname"></span>
    </div>
  </header>

  <section class="banner">
    <div class="carousel">
      <div class="slides" id="carouselSlides">
        <!-- è½®æ’­å›¾å°†åŠ¨æ€åŠ è½½éŸ³ä¹å°é¢ -->
        <div class="slide active" style="background-image:url('https://picsum.photos/id/1062/1920/600');"></div>
        <div class="slide" style="background-image:url('https://picsum.photos/id/1062/1920/600');"></div>
        <div class="slide" style="background-image:url('https://picsum.photos/id/1062/1920/600');"></div>
        <div class="slide" style="background-image:url('https://picsum.photos/id/1062/1920/600');"></div>
        <div class="slide" style="background-image:url('https://picsum.photos/id/1062/1920/600');"></div>
      </div>
      <button class="carousel-btn prev">&#10094;</button>
      <button class="carousel-btn next">&#10095;</button>
    </div>
    
    <!-- æ™ºèƒ½éŸ³ä¹åŠ©æ‰‹èŠå¤©æœºå™¨äºº -->
    <div class="ai-assistant">
      <h3>ğŸµ æ™ºèƒ½éŸ³ä¹åŠ©æ‰‹</h3>
      <div class="ai-chat-container">
        <div class="ai-messages" id="aiMessages">
          <div class="ai-message ai-bot">
            <div class="message-content">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºèƒ½éŸ³ä¹åŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨æ¨èæ­Œæ›²ã€è§£ç­”éŸ³ä¹é—®é¢˜ã€ç®¡ç†æ­Œå•ç­‰ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ</div>
          </div>
        </div>
        <div class="ai-input-container">
          <input type="text" class="ai-input" id="aiInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." maxlength="200">
          <button class="ai-send-btn" id="aiSendBtn">å‘é€</button>
        </div>
      </div>
    </div>

  </section>

  <main class="content">
    <!-- æœ¬åœ°éŸ³ä¹åº“å±•ç¤ºåŒºåŸŸ -->
    <div class="local-music-container">
    <section class="local-music-section">
      <div class="section-header">
        <h2>ğŸµ æœ¬åœ°éŸ³ä¹åº“</h2>
        <div class="section-actions">
          <button id="refreshMusicBtn" class="btn-secondary">åˆ·æ–°éŸ³ä¹åº“</button>
        </div>
      </div>
      
      <!-- éŸ³ä¹ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="music-stats">
        <div class="stat-item">
          <span class="stat-number" id="totalSongs">0</span>
          <span class="stat-label">æ€»æ­Œæ›²æ•°</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="totalAlbums">0</span>
          <span class="stat-label">ä¸“è¾‘æ•°</span>
        </div>
        <div class="stat-item">
          <span class="stat-number" id="totalArtists">0</span>
          <span class="stat-label">æ­Œæ‰‹æ•°</span>
        </div>
      </div>



      <!-- æœ¬åœ°éŸ³ä¹ç½‘æ ¼å±•ç¤ºï¼ˆæ–°å¢åŠŸèƒ½ï¼‰ -->
      <div class="section-header">
        <h2>ğŸµ æœ¬åœ°éŸ³ä¹åº“</h2>
        <div class="tabs">
          <a href="#" class="active" onclick="showGridLayout()">å°é¢è§†å›¾</a>
          <a href="#" onclick="showListLayout()">åˆ—è¡¨è§†å›¾</a>
        </div>
      </div>

      <!-- éŸ³ä¹ç½‘æ ¼å®¹å™¨ -->
      <section id="localMusicGrid" class="grid">
        <div class="loading">æ­£åœ¨åŠ è½½æœ¬åœ°éŸ³ä¹...</div>
      </section>

      <!-- æœ¬åœ°éŸ³ä¹åˆ—è¡¨ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰ -->
      <div id="musicListContainer" class="music-list-container hidden">
        <div class="music-list-header">
          <span class="header-title">æ­Œæ›²</span>
          <span class="header-artist">æ­Œæ‰‹</span>
          <span class="header-album">ä¸“è¾‘</span>
          <span class="header-actions">æ“ä½œ</span>
        </div>
        <div id="localMusicList" class="music-list">
          <div class="loading">æ­£åœ¨åŠ è½½æœ¬åœ°éŸ³ä¹...</div>
        </div>
      </div>

      <!-- ç©ºçŠ¶æ€æç¤º -->
      <div id="empty-local-music" class="empty-state hidden">
     
      </div>
    </section>
    </div>

    <!-- éŸ³ä¹æ•°æ®åŠ è½½åŒºåŸŸ -->
    <div id="music-data-container">
      <!-- è¿™é‡Œå°†åŠ¨æ€åŠ è½½äº‘ç«¯éŸ³ä¹æ•°æ® -->
    </div>

    <!-- ç©ºçŠ¶æ€æç¤º -->
    <div id="empty-state" class="empty-state hidden">
      <div class="empty-icon">ğŸµ</div>
      <h3>æš‚æ— éŸ³ä¹æ•°æ®</h3>
      <p>æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•éŸ³ä¹æ–‡ä»¶ï¼Œè¯·å…ˆä¸Šä¼ éŸ³ä¹æ–‡ä»¶</p>
      <a href="/upload" class="btn-gradient">ä¸Šä¼ éŸ³ä¹</a>
    </div>

    <aside class="sidebar">
      <!-- ä¾§è¾¹æ å†…å®¹å¯ä»¥æ·»åŠ å…¶ä»–åŠŸèƒ½æ¨¡å— -->
    </aside>
  </main>

  <footer class="footer">
    <div>Â© 2025 äº‘éŸ³ä¹ </div>
  </footer>

  <!-- å¯¼å…¥æœ¬åœ°æ­Œå•æ¨¡æ€æ¡† -->
  <div id="playlistModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="playlistTitle">
    <div class="modal-header">
      <div id="playlistTitle">å¯¼å…¥æœ¬åœ°æ­Œå•</div>
      <button class="modal-close" data-close="playlistModal">Ã—</button>
    </div>
    <div class="modal-body">
      <form id="playlistForm">
        <label class="form-row">
          <span>é€‰æ‹©éŸ³ä¹æ–‡ä»¶å¤¹</span>
          <input type="text" id="musicDirInput" placeholder="è¯·è¾“å…¥éŸ³ä¹æ–‡ä»¶å¤¹è·¯å¾„" readonly />
          <button type="button" id="browseBtn" class="btn-gradient">æµè§ˆ</button>
        </label>
        <div class="form-row">
          <span>å½“å‰è·¯å¾„</span>
          <code id="currentMusicDir">C:\Users\28890\Desktop\music</code>
        </div>
        <div class="form-help">
          <p>æç¤ºï¼šé€‰æ‹©åŒ…å«FLACéŸ³ä¹æ–‡ä»¶çš„æ–‡ä»¶å¤¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ‰«æå¹¶å¯¼å…¥æ‰€æœ‰éŸ³ä¹æ–‡ä»¶</p>
        </div>
        <button type="submit" class="btn-gradient full">å¯¼å…¥æ­Œå•</button>
      </form>
    </div>
  </div>

  <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
  <div id="modalOverlay" class="modal-overlay hidden"></div>

  <div id="loginModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-header">
      <div id="loginTitle">è´¦å·ç™»å½•</div>
      <button class="modal-close" data-close="loginModal">Ã—</button>
    </div>
    <div class="modal-body">
      <form id="loginForm">
        <label class="form-row">
          <span>è´¦å·</span>
          <input type="text" id="loginAccount" placeholder="è¯·è¾“å…¥è´¦å·" required />
        </label>
        <label class="form-row">
          <span>å¯†ç </span>
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </label>
        <label class="form-row inline">
          <input type="checkbox" id="loginAuto" checked />
          <span>è‡ªåŠ¨ç™»å½•</span>
        </label>
        <button type="submit" class="btn-gradient full">ç™»å½•</button>
      </form>
    </div>
  </div>

  <div id="registerModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
    <div class="modal-header">
      <div id="registerTitle">è´¦å·æ³¨å†Œ</div>
      <button class="modal-close" data-close="registerModal">Ã—</button>
    </div>
    <div class="modal-body">
      <form id="registerForm">
        <label class="form-row">
          <span>è´¦å·</span>
          <input type="text" id="registerAccount" placeholder="è¯·è¾“å…¥è´¦å·" required />
        </label>
        <label class="form-row">
          <span>å¯†ç </span>
          <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </label>
        <button type="submit" class="btn-gradient full">æ³¨å†Œ</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__SUPABASE_URL__ = window.__SUPABASE_URL__ || 'https://gblnpzstdjnvclijjpbk.supabase.co';
    window.__SUPABASE_ANON_KEY__ = window.__SUPABASE_ANON_KEY__ || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdibG5wenN0ZGpudmNsaWpqcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjgzNjEsImV4cCI6MjA3NjA0NDM2MX0.YaMwiKVVUgToza4vMtBjHAgvE28fdWTqtNHHtI9peFU';
  </script>
  <script src="app.js"></script>
  <script>
    // åŠ¨æ€åŠ è½½éŸ³ä¹æ•°æ®
    document.addEventListener('DOMContentLoaded', async () => {
      await loadLocalMusicData();
      await loadMusicData();
      
      // æ›´æ–°è½®æ’­å›¾ï¼ˆåœ¨éŸ³ä¹æ•°æ®åŠ è½½åï¼‰
      await updateCarouselWithCovers();
      
      // åˆå§‹åŒ–è½®æ’­å›¾åŠŸèƒ½
      setTimeout(() => {
        initCarousel();
      }, 100);
      
      // åˆå§‹åŒ–æ™ºèƒ½éŸ³ä¹åŠ©æ‰‹
      initAIAssistant();
    });

    // åŠ è½½æœ¬åœ°éŸ³ä¹æ•°æ®
    async function loadLocalMusicData() {
      const musicGrid = document.getElementById('localMusicGrid');
      const musicList = document.getElementById('localMusicList');
      const emptyState = document.getElementById('empty-local-music');
      const totalSongs = document.getElementById('totalSongs');
      const totalAlbums = document.getElementById('totalAlbums');
      const totalArtists = document.getElementById('totalArtists');
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        musicGrid.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æœ¬åœ°éŸ³ä¹...</div>';
        musicList.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æœ¬åœ°éŸ³ä¹...</div>';
        
        // è·å–æœ¬åœ°éŸ³ä¹æ•°æ®
        const response = await fetch('/api/music');
        const tracks = await response.json();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³ä¹æ•°æ®
        if (!tracks || tracks.length === 0) {
          // æ²¡æœ‰éŸ³ä¹æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
          musicGrid.innerHTML = '';
          musicList.innerHTML = '';
          emptyState.classList.remove('hidden');
          
          // é‡ç½®ç»Ÿè®¡ä¿¡æ¯
          totalSongs.textContent = '0';
          totalAlbums.textContent = '0';
          totalArtists.textContent = '0';
          return;
        }
        
        // æœ‰éŸ³ä¹æ•°æ®ï¼Œéšè—ç©ºçŠ¶æ€
        emptyState.classList.add('hidden');
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        updateMusicStats(tracks);
        
        // æ¸²æŸ“ä¸¤ç§è§†å›¾
        renderMusicCardGrid(tracks, musicGrid);
        renderLocalMusicList(tracks, musicList);
        
      } catch (error) {
        console.error('åŠ è½½æœ¬åœ°éŸ³ä¹æ•°æ®å¤±è´¥:', error);
        musicGrid.innerHTML = '<div class="no-results">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
        musicList.innerHTML = '<div class="no-results">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
        emptyState.classList.remove('hidden');
      }
    }

    // æ›´æ–°éŸ³ä¹ç»Ÿè®¡ä¿¡æ¯
    function updateMusicStats(tracks) {
      const totalSongs = document.getElementById('totalSongs');
      const totalAlbums = document.getElementById('totalAlbums');
      const totalArtists = document.getElementById('totalArtists');
      
      // è®¡ç®—ä¸“è¾‘æ•°ï¼ˆå»é‡ï¼‰
      const albums = new Set();
      const artists = new Set();
      
      tracks.forEach(track => {
        if (track.album) albums.add(track.album);
        if (track.artist) artists.add(track.artist);
      });
      
      totalSongs.textContent = tracks.length;
      totalAlbums.textContent = albums.size;
      totalArtists.textContent = artists.size;
    }

    // æ¸²æŸ“æœ¬åœ°éŸ³ä¹åˆ—è¡¨
    function renderLocalMusicList(tracks, container) {
      if (!tracks || tracks.length === 0) {
        container.innerHTML = '<div class="no-results">æš‚æ— æœ¬åœ°éŸ³ä¹</div>';
        return;
      }
      
      const html = tracks.map(track => `
        <div class="music-list-item" data-track-id="${track.id}">
          <div class="song-title">${track.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
          <div class="song-artist">${track.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</div>
          <div class="song-album">${track.album || 'æœªçŸ¥ä¸“è¾‘'}</div>
          <div class="music-list-actions">
            <button class="play-btn" onclick="playLocalTrack(${track.id})">æ’­æ”¾</button>
            <button class="detail-btn" onclick="viewTrackDetail(${track.id})">è¯¦æƒ…</button>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    // æ–°å¢ï¼šæ¸²æŸ“éŸ³ä¹å¡ç‰‡ç½‘æ ¼å¸ƒå±€ - ä»æ–°é¡¹ç›®å¼•å…¥
    function renderMusicCardGrid(tracks, container) {
      if (!tracks || tracks.length === 0) {
        container.innerHTML = '<div class="no-results">æš‚æ— æœ¬åœ°éŸ³ä¹</div>';
        return;
      }
      
      const html = tracks.map(track => `
        <a class="card" href="/song?id=${track.id}">
          <div class="thumb" style="background-image:url('${track.hasCover ? `/api/cover?id=${track.id}` : 'https://picsum.photos/id/1062/300/300'}');"></div>
          <div class="card-info">
            <h3>${track.title || 'æœªçŸ¥æ ‡é¢˜'}</h3>
            <p>${track.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</p>
            <span class="playcount">${track.hasLyrics ? 'å«æ­Œè¯' : 'æ— æ­Œè¯'}</span>
          </div>
        </a>
      `).join('');
      
      container.innerHTML = html;
    }

    // æ–°å¢ï¼šè§†å›¾åˆ‡æ¢åŠŸèƒ½
    function showGridLayout() {
      const gridContainer = document.getElementById('localMusicGrid');
      const listContainer = document.getElementById('musicListContainer');
      const tabs = document.querySelectorAll('.tabs a');
      
      gridContainer.classList.remove('hidden');
      listContainer.classList.add('hidden');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      tabs[0].classList.add('active');
    }

    function showListLayout() {
      const gridContainer = document.getElementById('localMusicGrid');
      const listContainer = document.getElementById('musicListContainer');
      const tabs = document.querySelectorAll('.tabs a');
      
      gridContainer.classList.add('hidden');
      listContainer.classList.remove('hidden');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      tabs[1].classList.add('active');
    }

    // æ–°å¢ï¼šæ¸²æŸ“éŸ³ä¹å¡ç‰‡ç½‘æ ¼å¸ƒå±€ - ä»æ–°é¡¹ç›®å¼•å…¥
    function renderMusicCardGrid(tracks, container) {
      if (!tracks || tracks.length === 0) {
        container.innerHTML = '<div class="no-results">æš‚æ— æœ¬åœ°éŸ³ä¹</div>';
        return;
      }
      
      const html = tracks.map(track => `
        <a class="card" href="/song?id=${track.id}">
          <div class="thumb" style="background-image:url('${track.hasCover ? `/api/cover?id=${track.id}` : 'https://picsum.photos/id/1062/300/300'}');"></div>
          <div class="card-info">
            <h3>${track.title || 'æœªçŸ¥æ ‡é¢˜'}</h3>
            <p>${track.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</p>
            <span class="playcount">${track.hasLyrics ? 'å«æ­Œè¯' : 'æ— æ­Œè¯'}</span>
          </div>
        </a>
      `).join('');
      
      container.innerHTML = html;
    }

    // æ–°å¢ï¼šè§†å›¾åˆ‡æ¢åŠŸèƒ½
    function showGridLayout() {
      const gridContainer = document.getElementById('localMusicGrid');
      const listContainer = document.getElementById('musicListContainer');
      const tabs = document.querySelectorAll('.tabs a');
      
      gridContainer.classList.remove('hidden');
      listContainer.classList.add('hidden');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      tabs[0].classList.add('active');
    }

    function showListLayout() {
      const gridContainer = document.getElementById('localMusicGrid');
      const listContainer = document.getElementById('musicListContainer');
      const tabs = document.querySelectorAll('.tabs a');
      
      gridContainer.classList.add('hidden');
      listContainer.classList.remove('hidden');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      tabs[1].classList.add('active');
    }

    // æ’­æ”¾æœ¬åœ°éŸ³ä¹
    async function playLocalTrack(trackId) {
      try {
        // è·å–æ­Œæ›²ä¿¡æ¯
        const response = await fetch(`/api/track?id=${trackId}`);
        if (!response.ok) throw new Error('æ­Œæ›²ä¿¡æ¯åŠ è½½å¤±è´¥');
        const track = await response.json();
        
        // è®¾ç½®éŸ³é¢‘æº
        const audio = document.getElementById('audio');
        audio.src = `/api/audio?id=${trackId}`;
        
        // æ›´æ–°æ’­æ”¾å™¨ä¿¡æ¯
        document.getElementById('playerTitle').textContent = track.title || 'æœªçŸ¥æ ‡é¢˜';
        document.getElementById('playerArtist').textContent = track.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
        
        // è®¾ç½®å°é¢
        const miniCover = document.getElementById('miniCover');
        if (track.hasCover) {
          miniCover.src = `/api/cover?id=${trackId}`;
        } else {
          miniCover.src = 'https://picsum.photos/id/1062/60/60';
        }
        
        // æ’­æ”¾
        await audio.play();
        
      } catch (error) {
        console.error('æ’­æ”¾æ­Œæ›²å¤±è´¥:', error);
        alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // æŸ¥çœ‹æ­Œæ›²è¯¦æƒ…
    function viewTrackDetail(trackId) {
      // è·³è½¬åˆ°æ­Œæ›²è¯¦æƒ…é¡µ
      window.location.href = `/song?id=${trackId}`;
    }

    // åˆ·æ–°éŸ³ä¹åº“
    document.getElementById('refreshMusicBtn').addEventListener('click', async () => {
      await loadLocalMusicData();
      alert('éŸ³ä¹åº“å·²åˆ·æ–°');
    });

    // è®¾ç½®éŸ³ä¹ç›®å½•
    document.getElementById('setupMusicDirBtn').addEventListener('click', () => {
      const playlistModal = document.getElementById('playlistModal');
      const modalOverlay = document.getElementById('modalOverlay');
      
      if (playlistModal && modalOverlay) {
        modalOverlay.classList.remove('hidden');
        playlistModal.classList.remove('hidden');
      }
    });

    // å¯¼å…¥æ­Œå•æŒ‰é’®
    document.getElementById('importPlaylistBtn').addEventListener('click', () => {
      const playlistModal = document.getElementById('playlistModal');
      const modalOverlay = document.getElementById('modalOverlay');
      
      if (playlistModal && modalOverlay) {
        modalOverlay.classList.remove('hidden');
        playlistModal.classList.remove('hidden');
      }
    });

    // åŠ è½½éŸ³ä¹æ•°æ®
    async function loadMusicData() {
      const container = document.getElementById('music-data-container');
      const emptyState = document.getElementById('empty-state');
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        container.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½éŸ³ä¹æ•°æ®...</div>';
        
        // è·å–äº‘ç«¯éŸ³ä¹æ•°æ®
        const response = await fetch('/api/cloud/music');
        const data = await response.json();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰éŸ³ä¹æ•°æ®
        if (data.total_count === 0) {
          // æ²¡æœ‰éŸ³ä¹æ•°æ®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
          container.innerHTML = '';
          emptyState.classList.remove('hidden');
          return;
        }
        
        // æœ‰éŸ³ä¹æ•°æ®ï¼Œéšè—ç©ºçŠ¶æ€
        emptyState.classList.add('hidden');
        
        // æ¸²æŸ“éŸ³ä¹æ•°æ®
        renderMusicData(data, container);
        
      } catch (error) {
        console.error('åŠ è½½éŸ³ä¹æ•°æ®å¤±è´¥:', error);
        container.innerHTML = '<div class="no-results">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
        emptyState.classList.remove('hidden');
      }
    }

    // æ¸²æŸ“éŸ³ä¹æ•°æ®
    function renderMusicData(data, container) {
      let html = '';
      
      // æ¸²æŸ“äº‘ç«¯éŸ³ä¹
      if (data.cloud_music && data.cloud_music.length > 0) {
        html += `
          <div class="music-section">
            <h2>äº‘ç«¯éŸ³ä¹ (${data.cloud_music.length})</h2>
            <div class="music-grid">
              ${data.cloud_music.map(music => createMusicCard(music, 'cloud')).join('')}
            </div>
          </div>
        `;
      }
      
      // æ¸²æŸ“æœ¬åœ°éŸ³ä¹
      if (data.local_music && data.local_music.length > 0) {
        html += `
          <div class="music-section">
            <h2>æœ¬åœ°éŸ³ä¹ (${data.local_music.length})</h2>
            <div class="music-grid">
              ${data.local_music.map(music => createMusicCard(music, 'local')).join('')}
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
      
      // æ·»åŠ éŸ³ä¹å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      container.querySelectorAll('.music-card').forEach(card => {
        card.addEventListener('click', function() {
          const musicId = this.dataset.musicId;
          const isCloud = this.dataset.source === 'cloud';
          playMusic(musicId, isCloud);
        });
      });
    }

    // åˆ›å»ºéŸ³ä¹å¡ç‰‡HTML
    function createMusicCard(music, source) {
      const coverUrl = music.cover || 'https://picsum.photos/300/300';
      const duration = formatDuration(music.duration || 0);
      
      return `
        <div class="music-card" data-music-id="${music.id}" data-source="${source}">
          <div class="music-cover" style="background-image: url('${coverUrl}')"></div>
          <div class="music-info">
            <div class="music-title">${music.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
            <div class="music-artist">${music.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}</div>
            <div class="music-meta">
              <span class="music-duration">${duration}</span>
              <span class="music-source ${source}">${source === 'cloud' ? 'äº‘ç«¯' : 'æœ¬åœ°'}</span>
            </div>
          </div>
        </div>
      `;
    }

    // æ ¼å¼åŒ–æ—¶é•¿
    function formatDuration(seconds) {
      if (!seconds) return '00:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // æ’­æ”¾éŸ³ä¹
    function playMusic(musicId, isCloud) {
      if (window.cloudMusicPlayer) {
        window.cloudMusicPlayer.playCloudMusic(musicId, isCloud);
      } else {
        // å¦‚æœæ²¡æœ‰äº‘ç«¯æ’­æ”¾å™¨ï¼Œä½¿ç”¨é»˜è®¤æ’­æ”¾æ–¹å¼
        const audio = document.getElementById('audio');
        if (audio) {
          if (isCloud) {
            audio.src = `/api/cloud/stream?id=${encodeURIComponent(musicId)}`;
          } else {
            audio.src = `/api/audio?id=${encodeURIComponent(musicId)}`;
          }
          audio.play();
        }
      }
    }

    // è½®æ’­å›¾åŠŸèƒ½å·²åœ¨ä¸» DOMContentLoaded ä¸­è°ƒç”¨ï¼Œè¿™é‡Œä¸å†é‡å¤åˆå§‹åŒ–

    // æ›´æ–°è½®æ’­å›¾ï¼šéšæœºé€‰æ‹©5å¼ éŸ³ä¹å°é¢
    async function updateCarouselWithCovers() {
      try {
        // è·å–æœ¬åœ°éŸ³ä¹åˆ—è¡¨
        const response = await fetch('/api/music');
        if (!response.ok) return;
        
        const tracks = await response.json();
        if (!Array.isArray(tracks) || tracks.length === 0) return;
        
        // ç­›é€‰å‡ºæœ‰å°é¢çš„æ­Œæ›²
        const tracksWithCover = tracks.filter(track => track.hasCover);
        
        if (tracksWithCover.length === 0) {
          console.log('æ²¡æœ‰æ‰¾åˆ°å¸¦å°é¢çš„æ­Œæ›²ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡');
          return;
        }
        
        // éšæœºé€‰æ‹©æœ€å¤š5å¼ å°é¢
        const shuffled = [...tracksWithCover].sort(() => Math.random() - 0.5);
        const selectedCovers = shuffled.slice(0, Math.min(5, tracksWithCover.length));
        
        // è·å–è½®æ’­å›¾å®¹å™¨
        const slidesContainer = document.getElementById('carouselSlides');
        if (!slidesContainer) return;
        
        // æ¸…ç©ºç°æœ‰è½®æ’­å›¾
        slidesContainer.innerHTML = '';
        
        // åˆ›å»ºæ–°çš„è½®æ’­å›¾å¹»ç¯ç‰‡
        selectedCovers.forEach((track, index) => {
          const slide = document.createElement('div');
          slide.className = 'slide';
          if (index === 0) {
            slide.classList.add('active');
          }
          
          // ä½¿ç”¨éŸ³ä¹å°é¢
          const coverUrl = `/api/cover?id=${track.id}`;
          slide.style.backgroundImage = `url('${coverUrl}')`;
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»å°é¢è·³è½¬åˆ°æ­Œæ›²è¯¦æƒ…é¡µ
          slide.style.cursor = 'pointer';
          slide.addEventListener('click', () => {
            window.location.href = `/song?id=${track.id}`;
          });
          
          slidesContainer.appendChild(slide);
        });
        
        // å¦‚æœé€‰æ‹©çš„å°é¢å°‘äº5å¼ ï¼Œç”¨é»˜è®¤å›¾ç‰‡å¡«å……
        while (slidesContainer.children.length < 5) {
          const slide = document.createElement('div');
          slide.className = 'slide';
          slide.style.backgroundImage = "url('https://picsum.photos/id/1062/1920/600')";
          slidesContainer.appendChild(slide);
        }
        
        console.log('è½®æ’­å›¾å·²æ›´æ–°ï¼Œä½¿ç”¨äº†', selectedCovers.length, 'å¼ éŸ³ä¹å°é¢');
      } catch (error) {
        console.error('æ›´æ–°è½®æ’­å›¾å¤±è´¥:', error);
      }
    }

    // åˆå§‹åŒ–è½®æ’­å›¾åŠŸèƒ½ï¼ˆå·¦å³åˆ‡æ¢ï¼‰
    function initCarousel() {
      const slides = document.querySelectorAll('.slide');
      const prevBtn = document.querySelector('.carousel-btn.prev');
      const nextBtn = document.querySelector('.carousel-btn.next');
      
      if (!slides.length) {
        console.warn('æœªæ‰¾åˆ°è½®æ’­å›¾å¹»ç¯ç‰‡');
        return;
      }
      
      let currentSlide = 0;
      let autoSlideInterval = null;
      
      function showSlide(index) {
        // ç¡®ä¿ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;
        
        // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
        slides.forEach(slide => slide.classList.remove('active'));
        
        // æ·»åŠ æ´»åŠ¨çŠ¶æ€åˆ°å½“å‰å¹»ç¯ç‰‡
        if (slides[index]) {
          slides[index].classList.add('active');
        }
        
        currentSlide = index;
      }
      
      function nextSlide() {
        currentSlide = (currentSlide + 1) % slides.length;
        showSlide(currentSlide);
      }
      
      function prevSlide() {
        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
        showSlide(currentSlide);
      }
      
      // ç»‘å®šå·¦å³æŒ‰é’®äº‹ä»¶
      if (prevBtn) {
        prevBtn.addEventListener('click', (e) => {
          e.preventDefault();
          prevSlide();
          // é‡ç½®è‡ªåŠ¨è½®æ’­
          resetAutoSlide();
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
          e.preventDefault();
          nextSlide();
          // é‡ç½®è‡ªåŠ¨è½®æ’­
          resetAutoSlide();
        });
      }
      
      // è‡ªåŠ¨è½®æ’­åŠŸèƒ½
      function startAutoSlide() {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (autoSlideInterval) {
          clearInterval(autoSlideInterval);
        }
        // æ¯5ç§’è‡ªåŠ¨åˆ‡æ¢
        autoSlideInterval = setInterval(() => {
          nextSlide();
        }, 5000);
      }
      
      function resetAutoSlide() {
        // é‡ç½®è‡ªåŠ¨è½®æ’­
        if (autoSlideInterval) {
          clearInterval(autoSlideInterval);
        }
        startAutoSlide();
      }
      
      // é¼ æ ‡æ‚¬åœæ—¶æš‚åœè‡ªåŠ¨è½®æ’­
      const carousel = document.querySelector('.carousel');
      if (carousel) {
        carousel.addEventListener('mouseenter', () => {
          if (autoSlideInterval) {
            clearInterval(autoSlideInterval);
          }
        });
        
        carousel.addEventListener('mouseleave', () => {
          startAutoSlide();
        });
      }
      
      // åˆå§‹åŒ–ï¼šæ˜¾ç¤ºç¬¬ä¸€å¼ ï¼Œå¼€å§‹è‡ªåŠ¨è½®æ’­
      showSlide(0);
      startAutoSlide();
      
      console.log('è½®æ’­å›¾åˆå§‹åŒ–å®Œæˆï¼Œå…±', slides.length, 'å¼ å›¾ç‰‡');
    }

    // å¯¼å…¥æœ¬åœ°æ­Œå•åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      const playlistsBtn = document.getElementById('playlistsBtn');
      const playlistModal = document.getElementById('playlistModal');
      const modalOverlay = document.getElementById('modalOverlay');
      const musicDirInput = document.getElementById('musicDirInput');
      const browseBtn = document.getElementById('browseBtn');
      const playlistForm = document.getElementById('playlistForm');
      const currentMusicDir = document.getElementById('currentMusicDir');

      // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†ï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
      if (playlistsBtn && playlistModal) {
        playlistsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          openModal(playlistModal);
        });
      }

      // æµè§ˆæ–‡ä»¶å¤¹ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
      browseBtn.addEventListener('click', () => {
        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
        // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨æç¤ºæ¡†è®©ç”¨æˆ·è¾“å…¥è·¯å¾„
        const path = prompt('è¯·è¾“å…¥éŸ³ä¹æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆä¾‹å¦‚ï¼šC:\\Users\\ç”¨æˆ·å\\Musicï¼‰:');
        if (path) {
          musicDirInput.value = path;
        }
      });

      // æäº¤å¯¼å…¥è¡¨å•
      playlistForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const musicDir = musicDirInput.value.trim();
        if (!musicDir) {
          alert('è¯·é€‰æ‹©éŸ³ä¹æ–‡ä»¶å¤¹è·¯å¾„');
          return;
        }

        try {
          // è°ƒç”¨APIæ›´æ–°éŸ³ä¹ç›®å½•
          const response = await fetch('/api/update_music_dir', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ musicDir })
          });

          if (response.ok) {
            const result = await response.json();
            alert('æ­Œå•å¯¼å…¥æˆåŠŸï¼ç³»ç»Ÿå°†é‡æ–°æ‰«æéŸ³ä¹æ–‡ä»¶ã€‚');
            closeModal(playlistModal);
            
            // æ›´æ–°å½“å‰è·¯å¾„æ˜¾ç¤º
            currentMusicDir.textContent = musicDir;
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥åˆ·æ–°éŸ³ä¹æ•°æ®
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } else {
            throw new Error('å¯¼å…¥å¤±è´¥');
          }
        } catch (error) {
          console.error('å¯¼å…¥æ­Œå•å¤±è´¥:', error);
          alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®');
        }
      });

      // æ¨¡æ€æ¡†æ§åˆ¶å‡½æ•°
      function openModal(modal) {
        modalOverlay.classList.remove('hidden');
        modal.classList.remove('hidden');
      }

      function closeModal(modal) {
        modalOverlay.classList.add('hidden');
        modal.classList.add('hidden');
      }

      // å…³é—­æŒ‰é’®
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
          const modalId = btn.getAttribute('data-close');
          const modal = document.getElementById(modalId);
          closeModal(modal);
        });
      });

      // ç‚¹å‡»é®ç½©å…³é—­
      modalOverlay.addEventListener('click', () => {
        closeModal(playlistModal);
        closeModal(document.getElementById('loginModal'));
        closeModal(document.getElementById('registerModal'));
      });

      // Escé”®å…³é—­
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal(playlistModal);
          closeModal(document.getElementById('loginModal'));
          closeModal(document.getElementById('registerModal'));
        }
      });

      // è·å–å½“å‰éŸ³ä¹ç›®å½•
      fetch('/api/get_music_dir')
        .then(response => response.json())
        .then(data => {
          if (data.musicDir) {
            currentMusicDir.textContent = data.musicDir;
          }
        })
        .catch(error => {
          console.error('è·å–éŸ³ä¹ç›®å½•å¤±è´¥:', error);
        });
    });
    
    // åˆå§‹åŒ–ç™»å½•çŠ¶æ€ç®¡ç†
    if (window.authManager) {
      window.authManager.initAllPagesAuth();
    }



    function initAIAssistant() {
      const aiMessages = document.getElementById('aiMessages');
      const aiInput = document.getElementById('aiInput');
      const aiSendBtn = document.getElementById('aiSendBtn');
      
      if (!aiMessages || !aiInput || !aiSendBtn) return;

      // æ™ºèƒ½ä½“é…ç½®ä¿¡æ¯
      const BOT_ID = '7567959568312369215'; // æ‚¨çš„æ™ºèƒ½ä½“ID
      const SPACE_ID = '7559750439882375218'; // æ‚¨çš„ç©ºé—´ID

      // å‘é€æ¶ˆæ¯å‡½æ•°
      async function sendMessage() {
        const message = aiInput.value.trim();
        if (!message) return;

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessage(message, 'user');
        aiInput.value = '';
        aiSendBtn.disabled = true;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingMessage = addMessage('æ­£åœ¨æ€è€ƒä¸­...', 'bot', true);

        try {
          // è°ƒç”¨åç«¯AIèŠå¤©æ¥å£
          const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: message,
              user_id: 'music_web_user'
            })
          });
          
          console.log('AIåŠ©æ‰‹å“åº”çŠ¶æ€:', response.status, response.statusText);

          if (!response.ok) {
            throw new Error(`AIåŠ©æ‰‹æœåŠ¡é”™è¯¯: ${response.status} - ${response.statusText}`);
          }

          const data = await response.json();
          console.log('AIåŠ©æ‰‹å“åº”æ•°æ®:', data);
          
          // ç§»é™¤åŠ è½½çŠ¶æ€
          loadingMessage.remove();
          
          // æ·»åŠ AIå›å¤
          if (data.success && data.message) {
            addMessage(data.message, 'bot');
          } else {
            addMessage('æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚', 'bot');
          }

        } catch (error) {
          console.error('AIåŠ©æ‰‹é”™è¯¯è¯¦æƒ…:', {
            error: error.message,
            name: error.name,
            stack: error.stack
          });
          
          // ç§»é™¤åŠ è½½çŠ¶æ€
          loadingMessage.remove();
          
          // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯
          let errorMessage = 'æŠ±æ­‰ï¼Œç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚';
          
          if (error.message.includes('Failed to fetch')) {
            errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIæœåŠ¡çŠ¶æ€ã€‚';
          } else if (error.message.includes('401') || error.message.includes('403')) {
            errorMessage = 'APIè®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Tokenæ˜¯å¦æ­£ç¡®ã€‚';
          } else if (error.message.includes('404')) {
            errorMessage = 'APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥APIåœ°å€æ˜¯å¦æ­£ç¡®ã€‚';
          } else if (error.message.includes('429')) {
            errorMessage = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚';
          } else if (error.message.includes('500')) {
            errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚';
          }
          
          addMessage(errorMessage, 'bot');
        }

        aiSendBtn.disabled = false;
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
      function addMessage(content, sender, isLoading = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ai-${sender}`;
        
        if (isLoading) {
          messageDiv.classList.add('loading');
        }
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        
        messageDiv.appendChild(contentDiv);
        aiMessages.appendChild(messageDiv);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        aiMessages.scrollTop = aiMessages.scrollHeight;
        
        return messageDiv;
      }

      // äº‹ä»¶ç›‘å¬
      aiSendBtn.addEventListener('click', sendMessage);
      
      aiInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // è¾“å…¥æ¡†è‡ªåŠ¨èšç„¦
      aiInput.focus();

      // è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
      aiInput.addEventListener('input', () => {
        aiSendBtn.disabled = !aiInput.value.trim();
      });
    }
  </script>
</body>
</html>