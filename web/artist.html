<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>歌手详情</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">雷森音乐</div>
    <nav class="nav">
      <a href="/">我的音乐</a>
      <a href="/artists">歌手</a>
      <a href="/albums">专辑</a>
      <a href="/playlists">我的歌单</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="搜索歌曲/歌手/专辑" />
    </div>
  </header>

  <main class="artist-page">
    <section class="artist-info">
      <div class="disc">
        <div class="disc-cover" id="artistCover" style="background-image:url('https://picsum.photos/id/1015/300/300');"></div>
      </div>
      <div class="meta">
        <h1 id="artistName"></h1>
        <div class="tags">
          <span class="tag" id="artistCategory"></span>
          <span class="tag" id="songCount"></span>
        </div>
        <p class="artist">歌手详情</p>

        <div class="actions">
          <button class="primary" id="playAllBtn">播放全部</button>
          <button id="collectBtn">收藏</button>
          <button id="shareBtn">分享</button>
        </div>
      </div>
    </section>

    <section class="artist-songs">
      <h2>歌曲列表</h2>
      <div class="songs-list" id="songsList">
        <div class="loading">加载中...</div>
      </div>
    </section>
  </main>

  <!-- 底部播放器栏 -->
  <div class="player-bar">
    <div class="player-left">
      <img class="mini-cover" id="miniCover" src="https://picsum.photos/id/1062/60/60" alt="cover" />
      <div class="track">
        <div class="title" id="playerTitle"></div>
        <div class="artist" id="playerArtist"></div>
      </div>
    </div>
    <div class="player-center">
      <button id="prevBtn">⏮</button>
      <button id="toggleBtn">⏯</button>
      <button id="nextBtn">⏭</button>
    </div>
    <div class="player-right">
      <div class="time">
        <span id="curTime">00:00</span> / <span id="durTime">00:00</span>
      </div>
      <input id="progress" type="range" min="0" max="100" value="0" />
      <div class="volume-container">
        <span class="volume-icon" id="volumeIcon">🔊</span>
        <input id="volume" type="range" min="0" max="100" value="80" />
      </div>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    // 获取URL中的歌手ID
    function getArtistId() {
      const path = window.location.pathname;
      const parts = path.split('/');
      return parts[parts.length - 1];
    }

    // 加载歌手信息
    async function loadArtistInfo() {
      const artistId = getArtistId();
      try {
        const response = await fetch(`/api/artist_detail/${artistId}`);
        if (!response.ok) throw new Error('歌手信息加载失败');
        const artist = await response.json();
        
        // 更新页面信息
        document.getElementById('artistName').textContent = artist.name;
        document.getElementById('artistCategory').textContent = getCategoryName(artist.category);
        document.getElementById('songCount').textContent = `${artist.songCount}首歌曲`;
        
        return artist;
      } catch (error) {
        console.error('加载歌手信息失败:', error);
        document.getElementById('artistName').textContent = '歌手信息加载失败';
      }
    }

    // 加载歌手歌曲列表
    async function loadArtistSongs() {
      const artistId = getArtistId();
      try {
        const response = await fetch(`/api/artist_tracks/${artistId}`);
        if (!response.ok) throw new Error('歌曲列表加载失败');
        const songs = await response.json();
        
        const songsList = document.getElementById('songsList');
        if (songs.length === 0) {
          songsList.innerHTML = '<div class="no-results">该歌手暂无歌曲</div>';
          return;
        }
        
        // 设置歌手封面为第一首歌的封面
        if (songs.length > 0) {
          const coverEl = document.getElementById('artistCover');
          coverEl.style.backgroundImage = `url('/api/cover?id=${songs[0].id}')`;
        }
        
        // 按专辑分组显示歌曲
        const groupedSongs = groupSongsByAlbum(songs);
        songsList.innerHTML = renderSongsList(groupedSongs);
        
        // 添加歌曲点击事件
        addSongClickEvents(songs);
        
        return songs;
      } catch (error) {
        console.error('加载歌曲列表失败:', error);
        document.getElementById('songsList').innerHTML = '<div class="no-results">歌曲列表加载失败</div>';
      }
    }

    // 按专辑分组歌曲
    function groupSongsByAlbum(songs) {
      const groups = {};
      songs.forEach(song => {
        const album = song.album || '未知专辑';
        if (!groups[album]) {
          groups[album] = [];
        }
        groups[album].push(song);
      });
      return groups;
    }

    // 渲染歌曲列表
    function renderSongsList(groupedSongs) {
      let html = '';
      for (const [album, songs] of Object.entries(groupedSongs)) {
        html += `
          <div class="album-group">
            <h3 class="album-title">${album}</h3>
            <div class="songs-container">
              ${songs.map((song, index) => `
                <div class="song-item" data-song-id="${song.id}">
                  <span class="song-index">${index + 1}</span>
                  <div class="song-info">
                    <div class="song-title">${song.title || '未知标题'}</div>
                    <div class="song-album">${song.album || '未知专辑'}</div>
                  </div>
                  <div class="song-actions">
                    <button class="play-btn" data-song-id="${song.id}">播放</button>
                    <button class="collect-btn">收藏</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      return html;
    }

    // 添加歌曲点击事件
    function addSongClickEvents(songs) {
      // 播放按钮点击事件
      document.querySelectorAll('.play-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const songId = btn.dataset.songId;
          playSong(songId, songs);
        });
      });
      
      // 歌曲项点击事件（整行点击播放）
      document.querySelectorAll('.song-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('play-btn') && !e.target.classList.contains('collect-btn')) {
            const songId = item.dataset.songId;
            playSong(songId, songs);
          }
        });
      });
    }

    // 播放歌曲
    async function playSong(songId, playlist) {
      try {
        // 获取歌曲信息
        const response = await fetch(`/api/track?id=${songId}`);
        if (!response.ok) throw new Error('歌曲信息加载失败');
        const song = await response.json();
        
        // 设置音频源
        const audio = document.getElementById('audio');
        audio.src = `/api/audio?id=${songId}`;
        
        // 更新播放器信息
        document.getElementById('playerTitle').textContent = song.title || '未知标题';
        document.getElementById('playerArtist').textContent = song.artist || '未知艺术家';
        document.getElementById('miniCover').src = `/api/cover?id=${songId}`;
        
        // 播放
        await audio.play();
        
        // 设置当前播放列表和索引（基于当前页面的歌曲列表）
        currentPlaylist = playlist;
        currentIndex = currentPlaylist.findIndex(track => track.id == songId);
        
      } catch (error) {
        console.error('播放歌曲失败:', error);
        alert('播放失败，请稍后重试');
      }
    }

    // 播放全部
    document.getElementById('playAllBtn').addEventListener('click', async () => {
      const artistId = getArtistId();
      try {
        const response = await fetch(`/api/artist_tracks/${artistId}`);
        if (!response.ok) throw new Error('歌曲列表加载失败');
        const songs = await response.json();
        
        if (songs.length > 0) {
          // 播放第一首歌曲
          playSong(songs[0].id, songs);
        }
      } catch (error) {
        console.error('播放全部失败:', error);
      }
    });

    // 获取分类名称
    function getCategoryName(category) {
      const categories = {
        'chinese': '华语',
        'western': '欧美', 
        'korean': '韩语',
        'japanese': '日语',
        'other': '其他'
      };
      return categories[category] || '其他';
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', async () => {
      // 加载歌手信息和歌曲列表
      await loadArtistInfo();
      const songs = await loadArtistSongs();
      
      // 初始化播放器控制（复用歌曲页的播放器代码）
      initPlayerControls();
    });

    // 播放器控制初始化
    let currentPlaylist = [];
    let currentIndex = -1;

    function initPlayerControls() {
      const audio = document.getElementById('audio');
      const toggleBtn = document.getElementById('toggleBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progress = document.getElementById('progress');
      const volume = document.getElementById('volume');
      const curTime = document.getElementById('curTime');
      const durTime = document.getElementById('durTime');

      // 播放/暂停
      toggleBtn.addEventListener('click', async () => {
        if (audio.paused) {
          await audio.play();
        } else {
          audio.pause();
        }
      });

      // 上一首
      prevBtn.addEventListener('click', () => {
        if (currentPlaylist.length > 0 && currentIndex > 0) {
          currentIndex--;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });

      // 下一首
      nextBtn.addEventListener('click', () => {
        if (currentPlaylist.length > 0 && currentIndex < currentPlaylist.length - 1) {
          currentIndex++;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });

      // 进度条控制
      let isSeeking = false;
      progress.addEventListener('input', () => {
        if (isFinite(audio.duration)) {
          const value = Number(progress.value) || 0;
          audio.currentTime = value;
        }
      });

      progress.addEventListener('mousedown', () => { isSeeking = true; });
      progress.addEventListener('mouseup', () => { isSeeking = false; });

      // 音量控制
      volume.addEventListener('input', () => {
        audio.volume = volume.value / 100;
      });

      // 时间更新
      audio.addEventListener('timeupdate', () => {
        curTime.textContent = formatTime(audio.currentTime);
        if (!isSeeking && isFinite(audio.duration)) {
          progress.value = Math.floor(audio.currentTime);
        }
      });

      audio.addEventListener('loadedmetadata', () => {
        if (isFinite(audio.duration)) {
          durTime.textContent = formatTime(audio.duration);
          progress.max = Math.floor(audio.duration);
        }
      });

      // 歌曲播放结束自动下一首
      audio.addEventListener('ended', () => {
        if (currentPlaylist.length > 0 && currentIndex < currentPlaylist.length - 1) {
          currentIndex++;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });
    }

    // 更新播放歌曲函数，设置当前播放列表和索引
    async function playSong(songId) {
      try {
        // 获取歌曲信息
        const response = await fetch(`/api/track?id=${songId}`);
        if (!response.ok) throw new Error('歌曲信息加载失败');
        const song = await response.json();
        
        // 设置音频源
        const audio = document.getElementById('audio');
        audio.src = `/api/audio?id=${songId}`;
        
        // 更新播放器信息
        document.getElementById('playerTitle').textContent = song.title || '未知标题';
        document.getElementById('playerArtist').textContent = song.artist || '未知艺术家';
        document.getElementById('miniCover').src = `/api/cover?id=${songId}`;
        
        // 播放
        await audio.play();
        
        // 设置当前播放列表和索引
        const artistId = getArtistId();
        const tracksResponse = await fetch(`/api/artist_tracks/${artistId}`);
        if (tracksResponse.ok) {
          currentPlaylist = await tracksResponse.json();
          currentIndex = currentPlaylist.findIndex(track => track.id == songId);
        }
        
      } catch (error) {
        console.error('播放歌曲失败:', error);
        alert('播放失败，请稍后重试');
      }
    }

    // 格式化时间
    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>