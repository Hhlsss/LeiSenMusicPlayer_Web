<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ­Œæ‰‹è¯¦æƒ…</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">é›·æ£®éŸ³ä¹</div>
    <nav class="nav">
      <a href="/">æˆ‘çš„éŸ³ä¹</a>
      <a href="/artists">æ­Œæ‰‹</a>
      <a href="/albums">ä¸“è¾‘</a>
      <a href="/playlists">æˆ‘çš„æ­Œå•</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="æœç´¢æ­Œæ›²/æ­Œæ‰‹/ä¸“è¾‘" />
    </div>
  </header>

  <main class="artist-page">
    <section class="artist-info">
      <div class="disc">
        <div class="disc-cover" id="artistCover" style="background-image:url('https://picsum.photos/id/1015/300/300');"></div>
      </div>
      <div class="meta">
        <h1 id="artistName"></h1>
        <div class="tags">
          <span class="tag" id="artistCategory"></span>
          <span class="tag" id="songCount"></span>
        </div>
        <p class="artist">æ­Œæ‰‹è¯¦æƒ…</p>

        <div class="actions">
          <button class="primary" id="playAllBtn">æ’­æ”¾å…¨éƒ¨</button>
          <button id="collectBtn">æ”¶è—</button>
          <button id="shareBtn">åˆ†äº«</button>
        </div>
      </div>
    </section>

    <section class="artist-songs">
      <h2>æ­Œæ›²åˆ—è¡¨</h2>
      <div class="songs-list" id="songsList">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨æ’­æ”¾å™¨æ  -->
  <div class="player-bar">
    <div class="player-left">
      <img class="mini-cover" id="miniCover" src="https://picsum.photos/id/1062/60/60" alt="cover" />
      <div class="track">
        <div class="title" id="playerTitle"></div>
        <div class="artist" id="playerArtist"></div>
      </div>
    </div>
    <div class="player-center">
      <button id="prevBtn">â®</button>
      <button id="toggleBtn">â¯</button>
      <button id="nextBtn">â­</button>
    </div>
    <div class="player-right">
      <div class="time">
        <span id="curTime">00:00</span> / <span id="durTime">00:00</span>
      </div>
      <input id="progress" type="range" min="0" max="100" value="0" />
      <div class="volume-container">
        <span class="volume-icon" id="volumeIcon">ğŸ”Š</span>
        <input id="volume" type="range" min="0" max="100" value="80" />
      </div>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    // è·å–URLä¸­çš„æ­Œæ‰‹ID
    function getArtistId() {
      const path = window.location.pathname;
      const parts = path.split('/');
      return parts[parts.length - 1];
    }

    // åŠ è½½æ­Œæ‰‹ä¿¡æ¯
    async function loadArtistInfo() {
      const artistId = getArtistId();
      try {
        const response = await fetch(`/api/artist_detail/${artistId}`);
        if (!response.ok) throw new Error('æ­Œæ‰‹ä¿¡æ¯åŠ è½½å¤±è´¥');
        const artist = await response.json();
        
        // æ›´æ–°é¡µé¢ä¿¡æ¯
        document.getElementById('artistName').textContent = artist.name;
        document.getElementById('artistCategory').textContent = getCategoryName(artist.category);
        document.getElementById('songCount').textContent = `${artist.songCount}é¦–æ­Œæ›²`;
        
        return artist;
      } catch (error) {
        console.error('åŠ è½½æ­Œæ‰‹ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('artistName').textContent = 'æ­Œæ‰‹ä¿¡æ¯åŠ è½½å¤±è´¥';
      }
    }

    // åŠ è½½æ­Œæ‰‹æ­Œæ›²åˆ—è¡¨
    async function loadArtistSongs() {
      const artistId = getArtistId();
      try {
        const response = await fetch(`/api/artist_tracks/${artistId}`);
        if (!response.ok) throw new Error('æ­Œæ›²åˆ—è¡¨åŠ è½½å¤±è´¥');
        const songs = await response.json();
        
        const songsList = document.getElementById('songsList');
        if (songs.length === 0) {
          songsList.innerHTML = '<div class="no-results">è¯¥æ­Œæ‰‹æš‚æ— æ­Œæ›²</div>';
          return;
        }
        
        // è®¾ç½®æ­Œæ‰‹å°é¢ä¸ºç¬¬ä¸€é¦–æ­Œçš„å°é¢
        if (songs.length > 0) {
          const coverEl = document.getElementById('artistCover');
          coverEl.style.backgroundImage = `url('/api/cover?id=${songs[0].id}')`;
        }
        
        // æŒ‰ä¸“è¾‘åˆ†ç»„æ˜¾ç¤ºæ­Œæ›²
        const groupedSongs = groupSongsByAlbum(songs);
        songsList.innerHTML = renderSongsList(groupedSongs);
        
        // æ·»åŠ æ­Œæ›²ç‚¹å‡»äº‹ä»¶
        addSongClickEvents(songs);
        
        return songs;
      } catch (error) {
        console.error('åŠ è½½æ­Œæ›²åˆ—è¡¨å¤±è´¥:', error);
        document.getElementById('songsList').innerHTML = '<div class="no-results">æ­Œæ›²åˆ—è¡¨åŠ è½½å¤±è´¥</div>';
      }
    }

    // æŒ‰ä¸“è¾‘åˆ†ç»„æ­Œæ›²
    function groupSongsByAlbum(songs) {
      const groups = {};
      songs.forEach(song => {
        const album = song.album || 'æœªçŸ¥ä¸“è¾‘';
        if (!groups[album]) {
          groups[album] = [];
        }
        groups[album].push(song);
      });
      return groups;
    }

    // æ¸²æŸ“æ­Œæ›²åˆ—è¡¨
    function renderSongsList(groupedSongs) {
      let html = '';
      for (const [album, songs] of Object.entries(groupedSongs)) {
        html += `
          <div class="album-group">
            <h3 class="album-title">${album}</h3>
            <div class="songs-container">
              ${songs.map((song, index) => `
                <div class="song-item" data-song-id="${song.id}">
                  <span class="song-index">${index + 1}</span>
                  <div class="song-info">
                    <div class="song-title">${song.title || 'æœªçŸ¥æ ‡é¢˜'}</div>
                    <div class="song-album">${song.album || 'æœªçŸ¥ä¸“è¾‘'}</div>
                  </div>
                  <div class="song-actions">
                    <button class="play-btn" data-song-id="${song.id}">æ’­æ”¾</button>
                    <button class="collect-btn">æ”¶è—</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
      return html;
    }

    // æ·»åŠ æ­Œæ›²ç‚¹å‡»äº‹ä»¶
    function addSongClickEvents(songs) {
      // æ’­æ”¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.play-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const songId = btn.dataset.songId;
          playSong(songId, songs);
        });
      });
      
      // æ­Œæ›²é¡¹ç‚¹å‡»äº‹ä»¶ï¼ˆæ•´è¡Œç‚¹å‡»æ’­æ”¾ï¼‰
      document.querySelectorAll('.song-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (!e.target.classList.contains('play-btn') && !e.target.classList.contains('collect-btn')) {
            const songId = item.dataset.songId;
            playSong(songId, songs);
          }
        });
      });
    }

    // æ’­æ”¾æ­Œæ›²
    async function playSong(songId, playlist) {
      try {
        // è·å–æ­Œæ›²ä¿¡æ¯
        const response = await fetch(`/api/track?id=${songId}`);
        if (!response.ok) throw new Error('æ­Œæ›²ä¿¡æ¯åŠ è½½å¤±è´¥');
        const song = await response.json();
        
        // è®¾ç½®éŸ³é¢‘æº
        const audio = document.getElementById('audio');
        audio.src = `/api/audio?id=${songId}`;
        
        // æ›´æ–°æ’­æ”¾å™¨ä¿¡æ¯
        document.getElementById('playerTitle').textContent = song.title || 'æœªçŸ¥æ ‡é¢˜';
        document.getElementById('playerArtist').textContent = song.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
        document.getElementById('miniCover').src = `/api/cover?id=${songId}`;
        
        // æ’­æ”¾
        await audio.play();
        
        // è®¾ç½®å½“å‰æ’­æ”¾åˆ—è¡¨å’Œç´¢å¼•ï¼ˆåŸºäºå½“å‰é¡µé¢çš„æ­Œæ›²åˆ—è¡¨ï¼‰
        currentPlaylist = playlist;
        currentIndex = currentPlaylist.findIndex(track => track.id == songId);
        
      } catch (error) {
        console.error('æ’­æ”¾æ­Œæ›²å¤±è´¥:', error);
        alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // æ’­æ”¾å…¨éƒ¨
    document.getElementById('playAllBtn').addEventListener('click', async () => {
      const artistId = getArtistId();
      try {
        const response = await fetch(`/api/artist_tracks/${artistId}`);
        if (!response.ok) throw new Error('æ­Œæ›²åˆ—è¡¨åŠ è½½å¤±è´¥');
        const songs = await response.json();
        
        if (songs.length > 0) {
          // æ’­æ”¾ç¬¬ä¸€é¦–æ­Œæ›²
          playSong(songs[0].id, songs);
        }
      } catch (error) {
        console.error('æ’­æ”¾å…¨éƒ¨å¤±è´¥:', error);
      }
    });

    // è·å–åˆ†ç±»åç§°
    function getCategoryName(category) {
      const categories = {
        'chinese': 'åè¯­',
        'western': 'æ¬§ç¾', 
        'korean': 'éŸ©è¯­',
        'japanese': 'æ—¥è¯­',
        'other': 'å…¶ä»–'
      };
      return categories[category] || 'å…¶ä»–';
    }

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      // åŠ è½½æ­Œæ‰‹ä¿¡æ¯å’Œæ­Œæ›²åˆ—è¡¨
      await loadArtistInfo();
      const songs = await loadArtistSongs();
      
      // åˆå§‹åŒ–æ’­æ”¾å™¨æ§åˆ¶ï¼ˆå¤ç”¨æ­Œæ›²é¡µçš„æ’­æ”¾å™¨ä»£ç ï¼‰
      initPlayerControls();
    });

    // æ’­æ”¾å™¨æ§åˆ¶åˆå§‹åŒ–
    let currentPlaylist = [];
    let currentIndex = -1;

    function initPlayerControls() {
      const audio = document.getElementById('audio');
      const toggleBtn = document.getElementById('toggleBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progress = document.getElementById('progress');
      const volume = document.getElementById('volume');
      const curTime = document.getElementById('curTime');
      const durTime = document.getElementById('durTime');

      // æ’­æ”¾/æš‚åœ
      toggleBtn.addEventListener('click', async () => {
        if (audio.paused) {
          await audio.play();
        } else {
          audio.pause();
        }
      });

      // ä¸Šä¸€é¦–
      prevBtn.addEventListener('click', () => {
        if (currentPlaylist.length > 0 && currentIndex > 0) {
          currentIndex--;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });

      // ä¸‹ä¸€é¦–
      nextBtn.addEventListener('click', () => {
        if (currentPlaylist.length > 0 && currentIndex < currentPlaylist.length - 1) {
          currentIndex++;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });

      // è¿›åº¦æ¡æ§åˆ¶
      let isSeeking = false;
      progress.addEventListener('input', () => {
        if (isFinite(audio.duration)) {
          const value = Number(progress.value) || 0;
          audio.currentTime = value;
        }
      });

      progress.addEventListener('mousedown', () => { isSeeking = true; });
      progress.addEventListener('mouseup', () => { isSeeking = false; });

      // éŸ³é‡æ§åˆ¶
      volume.addEventListener('input', () => {
        audio.volume = volume.value / 100;
      });

      // æ—¶é—´æ›´æ–°
      audio.addEventListener('timeupdate', () => {
        curTime.textContent = formatTime(audio.currentTime);
        if (!isSeeking && isFinite(audio.duration)) {
          progress.value = Math.floor(audio.currentTime);
        }
      });

      audio.addEventListener('loadedmetadata', () => {
        if (isFinite(audio.duration)) {
          durTime.textContent = formatTime(audio.duration);
          progress.max = Math.floor(audio.duration);
        }
      });

      // æ­Œæ›²æ’­æ”¾ç»“æŸè‡ªåŠ¨ä¸‹ä¸€é¦–
      audio.addEventListener('ended', () => {
        if (currentPlaylist.length > 0 && currentIndex < currentPlaylist.length - 1) {
          currentIndex++;
          playSong(currentPlaylist[currentIndex].id, currentPlaylist);
        }
      });
    }

    // æ›´æ–°æ’­æ”¾æ­Œæ›²å‡½æ•°ï¼Œè®¾ç½®å½“å‰æ’­æ”¾åˆ—è¡¨å’Œç´¢å¼•
    async function playSong(songId) {
      try {
        // è·å–æ­Œæ›²ä¿¡æ¯
        const response = await fetch(`/api/track?id=${songId}`);
        if (!response.ok) throw new Error('æ­Œæ›²ä¿¡æ¯åŠ è½½å¤±è´¥');
        const song = await response.json();
        
        // è®¾ç½®éŸ³é¢‘æº
        const audio = document.getElementById('audio');
        audio.src = `/api/audio?id=${songId}`;
        
        // æ›´æ–°æ’­æ”¾å™¨ä¿¡æ¯
        document.getElementById('playerTitle').textContent = song.title || 'æœªçŸ¥æ ‡é¢˜';
        document.getElementById('playerArtist').textContent = song.artist || 'æœªçŸ¥è‰ºæœ¯å®¶';
        document.getElementById('miniCover').src = `/api/cover?id=${songId}`;
        
        // æ’­æ”¾
        await audio.play();
        
        // è®¾ç½®å½“å‰æ’­æ”¾åˆ—è¡¨å’Œç´¢å¼•
        const artistId = getArtistId();
        const tracksResponse = await fetch(`/api/artist_tracks/${artistId}`);
        if (tracksResponse.ok) {
          currentPlaylist = await tracksResponse.json();
          currentIndex = currentPlaylist.findIndex(track => track.id == songId);
        }
        
      } catch (error) {
        console.error('æ’­æ”¾æ­Œæ›²å¤±è´¥:', error);
        alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = Math.floor(seconds % 60);
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }
  </script>
</body>
</html>