<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ­Œæ›²è¯¦æƒ…</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">é›·æ£®éŸ³ä¹</div>
    <nav class="nav">
      <a href="/">æˆ‘çš„éŸ³ä¹</a>
      <a href="/artists">æ­Œæ‰‹</a>
      <a href="/albums">ä¸“è¾‘</a>
      <a href="/favorites">æˆ‘çš„æ”¶è—</a>
      <a href="/upload">ä¸Šä¼ </a>
      <a href="/forum">éŸ³ä¹è®ºå›</a>
      <a href="/profile">ä¸ªäººä¸­å¿ƒ</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="æœç´¢æ­Œæ›²/æ­Œæ‰‹/ä¸“è¾‘" />
    </div>
    <div class="user-actions">
      <button class="primary">åˆ›å»ºæ­Œå•</button>
      <button id="logoutBtn" class="hidden">é€€å‡º</button>
      <span id="userNickname" class="hidden nickname"></span>
    </div>
  </header>

  <main class="song-page">
    <section class="song-info">
      <div class="disc">
        <div class="disc-cover" style="background-image:url('https://picsum.photos/id/1062/300/300');"></div>
      </div>
      <div class="meta">
        <h1></h1>
        <div class="tags">
          <span class="tag">VIPå•æ›²</span>
          <span class="tag">æ—¥è¯­</span>
        </div>
        <p class="artist">æ­Œæ‰‹ï¼šVaundy</p>
        <p class="album">æ‰€å±ä¸“è¾‘ï¼šreplica</p>

        <div class="actions">
          <button class="primary" id="playBtn">æ’­æ”¾</button>
          <button id="favoriteBtn" class="favorite-btn">â¤ æ”¶è—</button>
          <button>åˆ†äº«</button>
          <button>ä¸‹è½½</button>
        </div>

        <article class="lyrics">
          <h3>æ­Œè¯</h3>
        </article>
      </div>

      <aside class="related">
        <!-- <h3>åŒ…å«è¿™é¦–æ­Œçš„æ­Œå•</h3>
        <ul>
          <li>æµè¡Œç²¾é€‰ Â· æ¯æ—¥æ¨è</li>
          <li>å¤æ—¥ç”µéŸ³ Â· æ´¾å¯¹ç²¾é€‰</li>
          <li>æ‘‡æ»šçƒ­æ½® Â· ä¹é˜Ÿåˆè¾‘</li>
        </ul> -->
      </aside>
    </section>

    <!-- è¯„è®ºåŒºåŸŸ -->
    <section class="comments-section">
      <h2>è¯„è®º</h2>
      
      <!-- ç™»å½•çŠ¶æ€æ£€æŸ¥ -->
      <div id="loginStatus" class="login-status hidden">
        <p>ä½ è¿˜æœªç™»å½•ï¼Œè¯·<a href="/" id="goToLogin">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
      </div>

      <!-- è¯„è®ºè¡¨å• -->
      <div id="commentForm" class="comment-form hidden">
        <div class="comment-input-container">
          <textarea id="commentInput" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." rows="3"></textarea>
          <button id="submitComment" class="primary">å‘è¡¨è¯„è®º</button>
        </div>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div id="commentsList" class="comments-list">
        <div class="loading">åŠ è½½è¯„è®ºä¸­...</div>
      </div>
    </section>
    </section>
  </main>

  <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
  <div id="modalOverlay" class="modal-overlay hidden"></div>

  <div id="loginModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-header">
      <div id="loginTitle">è´¦å·ç™»å½•</div>
      <button class="modal-close" data-close="loginModal">Ã—</button>
    </div>
    <div class="modal-body">
      <form id="loginForm">
        <label class="form-row">
          <span>è´¦å·</span>
          <input type="text" id="loginAccount" placeholder="è¯·è¾“å…¥è´¦å·" required />
        </label>
        <label class="form-row">
          <span>å¯†ç </span>
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </label>
        <label class="form-row inline">
          <input type="checkbox" id="loginAuto" checked />
          <span>è‡ªåŠ¨ç™»å½•</span>
        </label>
        <button type="submit" class="btn-gradient full">ç™»å½•</button>
      </form>
    </div>
  </div>

  <div id="registerModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
    <div class="modal-header">
      <div id="registerTitle">è´¦å·æ³¨å†Œ</div>
      <button class="modal-close" data-close="registerModal">Ã—</button>
    </div>
    <div class="modal-body">
      <form id="registerForm">
        <label class="form-row">
          <span>è´¦å·</span>
          <input type="text" id="registerAccount" placeholder="è¯·è¾“å…¥è´¦å·" required />
        </label>
        <label class="form-row">
          <span>å¯†ç </span>
          <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </label>
        <button type="submit" class="btn-gradient full">æ³¨å†Œ</button>
      </form>
    </div>
  </div>

  <!-- åº•éƒ¨æ’­æ”¾å™¨æ  -->
  <div class="player-bar">
    <div class="player-left">
      <img class="mini-cover" src="https://picsum.photos/id/1062/60/60" alt="cover" />
      <div class="track">
        <div class="title"></div>
        <div class="artist">Vaundy</div>
      </div>
    </div>
    <div class="player-center">
      <button id="prevBtn">â®</button>
      <button id="toggleBtn">â¯</button>
      <button id="nextBtn">â­</button>
    </div>
    <div class="player-right">
      <div class="time">
        <span id="curTime">00:00</span> / <span id="durTime">00:00</span>
      </div>
      <input id="progress" type="range" min="0" max="100" value="0" />
      <div class="volume-container">
        <span class="volume-icon" id="volumeIcon">ğŸ”Š</span>
        <input id="volume" type="range" min="0" max="100" value="80" />
      </div>
    </div>
    <audio id="audio" preload="metadata"></audio>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__SUPABASE_URL__ = window.__SUPABASE_URL__ || 'https://gblnpzstdjnvclijjpbk.supabase.co';
    window.__SUPABASE_ANON_KEY__ = window.__SUPABASE_ANON_KEY__ || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdibG5wenN0ZGpudmNsaWpqcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjgzNjEsImV4cCI6MjA3NjA0NDM2MX0.YaMwiKVVUgToza4vMtBjHAgvE28fdWTqtNHHtI9peFU';
  </script>
  <script src="app.js"></script>
  <script>
    // æ­Œæ›²é¡µé¢æ’­æ”¾å’Œæ”¶è—åŠŸèƒ½
    let currentSongId = '';
    let currentSongTitle = '';
    let currentSongArtist = '';
    let currentSongAlbum = '';
    let isFavorited = false;
    let audio = null;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      // è·å–URLå‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      currentSongId = urlParams.get('id') || '';
      currentSongTitle = urlParams.get('song') || '';
      currentSongArtist = urlParams.get('artist') || '';
      currentSongAlbum = urlParams.get('album') || '';

      console.log('æ­Œæ›²é¡µé¢åˆå§‹åŒ–ï¼Œå‚æ•°:', { currentSongId, currentSongTitle, currentSongArtist, currentSongAlbum });

      // æ£€æŸ¥æ˜¯å¦æœ‰æ­Œæ›²ID
      if (!currentSongId) {
        console.error('æœªæ‰¾åˆ°æ­Œæ›²IDï¼Œè¯·ä»é¦–é¡µé€‰æ‹©æ­Œæ›²');
        alert('æœªæ‰¾åˆ°æ­Œæ›²ä¿¡æ¯ï¼Œè¯·ä»é¦–é¡µé€‰æ‹©æ­Œæ›²');
        return;
      }

      // åˆå§‹åŒ–æ’­æ”¾å™¨
      initPlayer();

      // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿ app.js ä¸­çš„é€»è¾‘ï¼ˆå¦‚æœæœ‰ï¼‰å·²ç»æ‰§è¡Œ
      await new Promise(resolve => setTimeout(resolve, 100));

      // æ— è®ºæ˜¯å¦æœ‰URLå‚æ•°ï¼Œéƒ½å°è¯•ä»APIè·å–å®Œæ•´æ­Œæ›²ä¿¡æ¯
      // è¿™æ ·å¯ä»¥ç¡®ä¿æ˜¾ç¤ºçš„ä¿¡æ¯æ˜¯æœ€æ–°çš„
      try {
        await fetchSongInfo(currentSongId);
      } catch (error) {
        console.error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:', error);
        // å³ä½¿APIå¤±è´¥ï¼Œä¹Ÿå°è¯•ä½¿ç”¨URLå‚æ•°ä¸­çš„ä¿¡æ¯
        updatePageInfo();
        await checkFavoriteStatus();
        try {
          await loadAndPlaySong();
        } catch (loadErr) {
          console.error('åŠ è½½æ­Œæ›²å¤±è´¥:', loadErr);
        }
      }

      // åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½ï¼ˆåœ¨è·å–æ­Œæ›²ä¿¡æ¯åï¼‰
      initComments();

      // è®¾ç½®æ’­æ”¾æŒ‰é’®äº‹ä»¶
      const playBtn = document.getElementById('playBtn');
      if (playBtn) {
        playBtn.addEventListener('click', togglePlay);
      }

      // è®¾ç½®æ”¶è—æŒ‰é’®äº‹ä»¶
      const favoriteBtn = document.getElementById('favoriteBtn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', toggleFavorite);
      }
    });

    // åˆå§‹åŒ–æ’­æ”¾å™¨
    function initPlayer() {
      audio = document.getElementById('audio');
      if (!audio) {
        console.error('éŸ³é¢‘å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      // è®¾ç½®éŸ³é¢‘äº‹ä»¶ç›‘å¬
      audio.addEventListener('loadedmetadata', function() {
        updateDuration();
      });

      audio.addEventListener('timeupdate', function() {
        updateProgress();
      });

      audio.addEventListener('ended', function() {
        audio.currentTime = 0;
        updatePlayButton(false);
      });

      // è®¾ç½®æ’­æ”¾å™¨æ§åˆ¶
      const toggleBtn = document.getElementById('toggleBtn');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const progress = document.getElementById('progress');
      const volume = document.getElementById('volume');

      if (toggleBtn) toggleBtn.addEventListener('click', togglePlay);
      if (prevBtn) prevBtn.addEventListener('click', playPrevious);
      if (nextBtn) nextBtn.addEventListener('click', playNext);
      if (progress) progress.addEventListener('input', seekAudio);
      if (volume) volume.addEventListener('input', setVolume);
    }

    // åŠ è½½å¹¶æ’­æ”¾æ­Œæ›²
    async function loadAndPlaySong() {
      if (!currentSongId) {
        console.error('æ²¡æœ‰æ­Œæ›²ID');
        return;
      }

      if (!audio) {
        console.error('éŸ³é¢‘å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      try {
        // æ£€æŸ¥éŸ³é¢‘æºæ˜¯å¦å·²ç»è®¾ç½®ï¼ˆå¯èƒ½ç”± app.js è®¾ç½®ï¼‰
        const expectedSrc = `/api/audio?id=${currentSongId}`;
        if (audio.src && audio.src !== window.location.href && audio.src.includes(`/api/audio?id=${currentSongId}`)) {
          console.log('éŸ³é¢‘æºå·²è®¾ç½®:', audio.src);
          // å¦‚æœéŸ³é¢‘æºå·²ç»è®¾ç½®ï¼Œåªéœ€è¦ç­‰å¾…åŠ è½½å®Œæˆ
          if (audio.readyState >= 2) {
            // å·²ç»åŠ è½½äº†å…ƒæ•°æ®
            console.log('éŸ³é¢‘å…ƒæ•°æ®å·²åŠ è½½');
            updatePlayButton(false);
            return Promise.resolve();
          }
        } else {
          // è®¾ç½®éŸ³é¢‘æºä¸ºæœ¬åœ°éŸ³ä¹æ–‡ä»¶
          audio.src = expectedSrc;
          console.log('è®¾ç½®éŸ³é¢‘æº:', audio.src);
        }
        
        // åŠ è½½å°é¢å›¾ç‰‡
        await loadCoverImage();
        
        // åŠ è½½æ­Œè¯
        await loadLyrics();
        
        // ç­‰å¾…éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ
        return new Promise((resolve, reject) => {
          const onLoadedMetadata = () => {
            console.log('éŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ');
            audio.removeEventListener('loadedmetadata', onLoadedMetadata);
            audio.removeEventListener('error', onError);
            updatePlayButton(false); // é»˜è®¤æš‚åœçŠ¶æ€
            resolve();
          };
          
          const onError = (e) => {
            console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', e);
            audio.removeEventListener('loadedmetadata', onLoadedMetadata);
            audio.removeEventListener('error', onError);
            reject(new Error('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨'));
          };
          
          audio.addEventListener('loadedmetadata', onLoadedMetadata);
          audio.addEventListener('error', onError);
          
          // å¼€å§‹åŠ è½½éŸ³é¢‘
          audio.load();
          
          // è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
          setTimeout(() => {
            audio.removeEventListener('loadedmetadata', onLoadedMetadata);
            audio.removeEventListener('error', onError);
            reject(new Error('éŸ³é¢‘åŠ è½½è¶…æ—¶'));
          }, 30000); // 30ç§’è¶…æ—¶
        });
        
      } catch (error) {
        console.error('åŠ è½½æ­Œæ›²å¤±è´¥:', error);
        // ä¸æ˜¾ç¤ºå¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨å°è¯•æ’­æ”¾
        updatePlayButton(false);
      }
    }

    // åŠ è½½å°é¢å›¾ç‰‡
    async function loadCoverImage() {
      try {
        const discCover = document.querySelector('.disc-cover');
        const miniCover = document.querySelector('.mini-cover');
        
        // æ£€æŸ¥å°é¢æ˜¯å¦å­˜åœ¨
        const response = await fetch(`/api/cover?id=${currentSongId}`);
        if (!response.ok) {
          throw new Error('å°é¢ä¸å­˜åœ¨');
        }
        
        if (discCover) {
          discCover.style.backgroundImage = `url('/api/cover?id=${currentSongId}')`;
        }
        
        if (miniCover) {
          miniCover.src = `/api/cover?id=${currentSongId}`;
        }
      } catch (error) {
        console.error('åŠ è½½å°é¢å¤±è´¥:', error);
        // è®¾ç½®é»˜è®¤å°é¢
        const discCover = document.querySelector('.disc-cover');
        const miniCover = document.querySelector('.mini-cover');
        
        if (discCover) {
          discCover.style.backgroundImage = "url('https://picsum.photos/id/1062/300/300')";
        }
        
        if (miniCover) {
          miniCover.src = "https://picsum.photos/id/1062/60/60";
        }
      }
    }

    // åŠ è½½æ­Œè¯ï¼ˆå‚è€ƒå‚è€ƒé¡¹ç›®çš„å®ç°ï¼‰
    async function loadLyrics() {
      try {
        const lyricsEl = document.querySelector(".lyrics");
        if (!lyricsEl) {
          console.warn('æ­Œè¯å®¹å™¨æœªæ‰¾åˆ°');
          return;
        }

        // ä½¿ç”¨ lyrics_raw API è·å–åŸå§‹LRCæ ¼å¼æ­Œè¯ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
        const response = await fetch(`/api/lyrics_raw?id=${currentSongId}`);
        if (!response.ok) {
          lyricsEl.innerHTML = '<h3>æ­Œè¯</h3><p>æš‚æ— æ­Œè¯</p>';
          return;
        }

        const data = await response.json();
        if (!data || !data.lyrics) {
          lyricsEl.innerHTML = '<h3>æ­Œè¯</h3><p>æš‚æ— æ­Œè¯</p>';
          return;
        }

        const lyrics = data.lyrics;
        const lines = [];
        // å‚è€ƒå‚è€ƒé¡¹ç›®çš„æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é…è¡Œé¦–çš„æ—¶é—´æˆ³æ ¼å¼ [mm:ss.xxx]æ–‡æœ¬
        const re = /^\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\](.*)$/;
        
        // æŒ‰è¡Œåˆ†å‰²å¹¶è§£æï¼ˆå®Œå…¨å‚è€ƒå‚è€ƒé¡¹ç›®çš„å®ç°ï¼‰
        lyrics.split(/\r?\n/).forEach(raw => {
          const m = raw.match(re);
          if (m) {
            const min = parseInt(m[1], 10);
            const sec = parseInt(m[2], 10);
            const ms = m[3] ? parseInt(m[3], 10) : 0;
            // è®¡ç®—æ€»ç§’æ•°ï¼ˆå‚è€ƒå‚è€ƒé¡¹ç›®çš„è®¡ç®—æ–¹å¼ï¼‰
            const t = min * 60 + sec + ms / 1000;
            const text = m[4].trim();
            if (text) {
              // ç¡®ä¿ t æ˜¯æ•°å­—ç±»å‹
              lines.push({ t: Number(t), text });
            }
          }
        });
        
        console.log('è§£æåçš„æ­Œè¯è¡Œæ•°:', lines.length);
        if (lines.length > 0) {
          console.log('ç¬¬ä¸€è¡Œæ•°æ®:', { t: lines[0].t, text: lines[0].text, tType: typeof lines[0].t });
        }

        // æŒ‰æ—¶é—´æ’åº
        lines.sort((a, b) => a.t - b.t);

        if (!lines.length) {
          lyricsEl.innerHTML = '<h3>æ­Œè¯</h3><p>æš‚æ— æ­Œè¯</p>';
          return;
        }

        // æ¸²æŸ“ä¸ºè¡Œï¼ˆå®Œå…¨å‚è€ƒå‚è€ƒé¡¹ç›®çš„å®ç°ï¼‰
        lyricsEl.innerHTML = '<h3>æ­Œè¯</h3>';
        lines.forEach((ln) => {
          const p = document.createElement("p");
          p.textContent = ln.text;
          // å‚è€ƒå‚è€ƒé¡¹ç›®ï¼šä½¿ç”¨ dataset.t è®¾ç½®æ—¶é—´æˆ³
          // ç¡®ä¿å€¼æ˜¯æ•°å­—ç±»å‹ï¼Œdataset ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²
          p.dataset.t = ln.t;
          lyricsEl.appendChild(p);
        });
        
        // éªŒè¯æ—¶é—´æˆ³æ˜¯å¦æ­£ç¡®è®¾ç½®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        const allLines = lyricsEl.querySelectorAll('p');
        console.log('æ­Œè¯æ¸²æŸ“å®Œæˆï¼Œå…±', allLines.length, 'è¡Œ');
        if (allLines.length > 0) {
          const firstLine = allLines[0];
          const testTime = parseFloat(firstLine.dataset.t);
          console.log('ç¬¬ä¸€è¡ŒéªŒè¯:', {
            text: firstLine.textContent.substring(0, 20),
            dataset_t: firstLine.dataset.t,
            parsedTime: testTime,
            isValid: !isNaN(testTime)
          });
          
          // éªŒè¯å‰3è¡Œçš„æ—¶é—´æˆ³
          for (let i = 0; i < Math.min(3, allLines.length); i++) {
            const line = allLines[i];
            const time = parseFloat(line.dataset.t);
            console.log(`ç¬¬${i+1}è¡Œ: time=${time}, text="${line.textContent.substring(0, 15)}..."`);
          }
        }

        // è®¾ç½®æ­Œè¯æ»šåŠ¨å’Œé«˜äº®åŠŸèƒ½
        setupLyricsScrolling(lines);
        
      } catch (error) {
        console.error('åŠ è½½æ­Œè¯å¤±è´¥:', error);
        const lyricsEl = document.querySelector(".lyrics");
        if (lyricsEl) {
          lyricsEl.innerHTML = '<h3>æ­Œè¯</h3><p>æ­Œè¯åŠ è½½å¤±è´¥</p>';
        }
      }
    }

    // è§£æLRCæ ¼å¼æ­Œè¯
    function parseLrcLyrics(lyrics) {
      const lines = lyrics.split(/\r?\n|\r/).filter(line => line.trim());
      const parsed = [];
      
      // LRCæ—¶é—´æˆ³æ­£åˆ™è¡¨è¾¾å¼ï¼šåŒ¹é… [åˆ†:ç§’.æ¯«ç§’] æˆ– [åˆ†:ç§’] æ ¼å¼
      // æ”¯æŒ [mm:ss.xx] æˆ– [m:ss.xx] æ ¼å¼
      const timeRegex = /\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g;
      
      lines.forEach(line => {
        // æå–æ‰€æœ‰æ—¶é—´æˆ³
        const timeMatches = [];
        let match;
        // ä½¿ç”¨æ–°çš„æ­£åˆ™è¡¨è¾¾å¼å®ä¾‹æ¥æå–æ—¶é—´æˆ³ï¼Œé¿å…å½±å“åç»­çš„æ–‡æœ¬æå–
        const timeRegexForExtract = /\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g;
        while ((match = timeRegexForExtract.exec(line)) !== null) {
          const minutes = parseInt(match[1], 10);
          const seconds = parseInt(match[2], 10);
          const milliseconds = match[3] ? parseInt(match[3], 10) : 0;
          
          // è®¡ç®—æ€»ç§’æ•°ï¼ˆæ¯«ç§’è½¬ä¸ºç§’ï¼‰
          let totalSeconds = minutes * 60 + seconds;
          if (match[3]) {
            // å¦‚æœæ˜¯3ä½æ¯«ç§’ï¼Œç›´æ¥é™¤ä»¥1000ï¼›å¦‚æœæ˜¯1-2ä½ï¼ŒæŒ‰ç™¾æ¯«ç§’æˆ–åæ¯«ç§’å¤„ç†
            if (match[3].length === 3) {
              totalSeconds += milliseconds / 1000;
            } else if (match[3].length === 2) {
              totalSeconds += milliseconds / 100;
            } else {
              totalSeconds += milliseconds / 10;
            }
          }
          
          timeMatches.push(totalSeconds);
        }
        
        // ç§»é™¤æ‰€æœ‰æ—¶é—´æˆ³ï¼Œä¿ç•™æ­Œè¯æ–‡æœ¬ï¼ˆä½¿ç”¨æ–°çš„æ­£åˆ™è¡¨è¾¾å¼å®ä¾‹ï¼‰
        const textRegex = /\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g;
        const text = line.replace(textRegex, '').trim();
        
        // å¦‚æœæœ‰æ—¶é—´æˆ³ä½†æ²¡æœ‰æ–‡æœ¬ï¼Œè·³è¿‡
        if (!text && timeMatches.length === 0) return;
        
        // å¦‚æœè¿™ä¸€è¡Œæœ‰æ—¶é—´æˆ³ï¼Œä¸ºæ¯ä¸ªæ—¶é—´æˆ³åˆ›å»ºä¸€ä¸ªæ¡ç›®
        if (timeMatches.length > 0) {
          timeMatches.forEach(time => {
            if (text) {  // åªä¸ºæœ‰æ–‡æœ¬çš„æ¡ç›®æ·»åŠ 
              parsed.push({
                time: time,
                text: text
              });
            }
          });
        } else if (text) {
          // å¦‚æœæ²¡æœ‰æ—¶é—´æˆ³ä½†æœ‰æ–‡æœ¬ï¼Œå¯èƒ½éœ€è¦æŒ‰é¡ºåºæ·»åŠ ï¼ˆé€šå¸¸LRCæ ¼å¼æ¯è¡Œéƒ½æœ‰æ—¶é—´æˆ³ï¼‰
          // è¿™é‡Œå¯ä»¥é€‰æ‹©è·³è¿‡æˆ–ä½¿ç”¨å‰ä¸€è¡Œçš„æ—¶é—´æˆ³ï¼Œæš‚æ—¶è·³è¿‡
          console.warn('å‘ç°æ²¡æœ‰æ—¶é—´æˆ³çš„æ­Œè¯è¡Œ:', text);
        }
      });
      
      // æŒ‰æ—¶é—´æ’åº
      parsed.sort((a, b) => a.time - b.time);
      
      // å»é‡ï¼šå¦‚æœæœ‰ç›¸åŒæ—¶é—´çš„æ¡ç›®ï¼Œåªä¿ç•™ç¬¬ä¸€ä¸ª
      const unique = [];
      const seen = new Set();
      parsed.forEach(item => {
        const key = item.time.toFixed(3);
        if (!seen.has(key)) {
          seen.add(key);
          unique.push(item);
        }
      });
      
      return unique;
    }

    // è®¾ç½®æ­Œè¯æ»šåŠ¨æ•ˆæœï¼ˆå‚è€ƒå‚è€ƒé¡¹ç›®çš„å®ç°ï¼‰
    function setupLyricsScrolling(lines) {
      if (!audio) return;

      const lyricsEl = document.querySelector(".lyrics");
      if (!lyricsEl || !lines || lines.length === 0) return;

      // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ç›‘å¬å™¨
      if (audio.lyricsScrollHandler) {
        audio.removeEventListener('timeupdate', audio.lyricsScrollHandler);
      }

      // ç”¨æˆ·æ»šåŠ¨çŠ¶æ€
      let isUserScrolling = false;
      let scrollTimeout = null;
      
      // ç›‘å¬ç”¨æˆ·æ»šåŠ¨
      lyricsEl.addEventListener('scroll', () => {
        isUserScrolling = true;
        if (scrollTimeout) clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          isUserScrolling = false;
        }, 2000);
      });

      // ç‚¹å‡»æ­Œè¯è·³è½¬æ’­æ”¾åŠŸèƒ½ï¼ˆå®Œå…¨å‚è€ƒå‚è€ƒé¡¹ç›®çš„å®ç°ï¼‰
      lyricsEl.addEventListener('click', (e) => {
        // æŸ¥æ‰¾ç‚¹å‡»çš„å…ƒç´ ï¼ˆå¯èƒ½æ˜¯ <p> æ ‡ç­¾æˆ–å…¶å­å…ƒç´ ï¼‰
        let targetElement = e.target;
        
        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ <p> æ ‡ç­¾ï¼Œå‘ä¸ŠæŸ¥æ‰¾çˆ¶å…ƒç´ 
        while (targetElement && targetElement.tagName !== 'P' && targetElement !== lyricsEl) {
          targetElement = targetElement.parentElement;
        }
        
        // ç¡®ä¿ç‚¹å‡»çš„æ˜¯æ­Œè¯è¡Œï¼ˆ<p> æ ‡ç­¾ï¼‰
        if (targetElement && targetElement.tagName === 'P') {
          // å‚è€ƒå‚è€ƒé¡¹ç›®ï¼šç›´æ¥ä½¿ç”¨ dataset.tï¼ˆä¸æ¸²æŸ“æ—¶ä½¿ç”¨çš„å±æ€§ä¸€è‡´ï¼‰
          const targetTime = parseFloat(targetElement.dataset.t);
          
          // æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦æœ‰æ•ˆï¼ˆå‚è€ƒå‚è€ƒé¡¹ç›®çš„æ£€æŸ¥æ–¹å¼ï¼‰
          if (!isNaN(targetTime)) {
            // è®¾ç½®æ’­æ”¾ä½ç½®
            audio.currentTime = targetTime;
            
            // å¦‚æœéŸ³é¢‘æš‚åœï¼Œè‡ªåŠ¨æ’­æ”¾
            if (audio.paused) {
              audio.play().catch(err => {
                console.warn('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', err);
              });
            }
            
            // æ·»åŠ ç‚¹å‡»åé¦ˆæ•ˆæœ
            targetElement.style.transform = 'scale(1.05)';
            targetElement.style.transition = 'transform 0.2s';
            
            setTimeout(() => {
              targetElement.style.transform = '';
            }, 200);
            
            console.log('è·³è½¬åˆ°æ—¶é—´:', targetTime, 'ç§’ï¼Œæ­Œè¯:', targetElement.textContent);
          } else {
            console.warn('è¯¥æ­Œè¯è¡Œæ²¡æœ‰æœ‰æ•ˆçš„æ—¶é—´æˆ³ï¼Œdataset.t:', targetElement.dataset.t);
          }
        }
      });
      
      // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœï¼Œæç¤ºå¯ç‚¹å‡»
      const style = document.createElement('style');
      style.textContent = `
        .lyrics p {
          cursor: pointer;
          transition: all 0.2s ease;
        }
        .lyrics p:hover {
          transform: scale(1.02);
          opacity: 0.9;
        }
      `;
      document.head.appendChild(style);

      // é«˜äº®å‡½æ•°ï¼ˆå‚è€ƒå‚è€ƒé¡¹ç›®çš„å®ç°ï¼‰
      const highlight = (cur) => {
        let idx = 0;
        for (let i = 0; i < lines.length; i++) {
          if (cur >= lines[i].t) idx = i; else break;
        }
        const children = Array.from(lyricsEl.children).filter(el => el.tagName === 'P');
        children.forEach((el, i) => el.classList.toggle("active", i === idx));
        
        // å¦‚æœç”¨æˆ·æ²¡æœ‰åœ¨æ»šåŠ¨ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°é«˜äº®æ­Œè¯
        if (!isUserScrolling && children[idx]) {
          const activeElement = children[idx];
          const containerHeight = lyricsEl.clientHeight;
          const elementHeight = activeElement.offsetHeight;
          const elementTop = activeElement.offsetTop;
          
          // è®¡ç®—ç›®æ ‡æ»šåŠ¨ä½ç½®ï¼Œä½¿é«˜äº®æ­Œè¯æ˜¾ç¤ºåœ¨ä¸­å¤®
          const targetScrollTop = elementTop - (containerHeight / 2) - (elementHeight * 6);
          
          // ç¡®ä¿æ»šåŠ¨ä½ç½®åœ¨åˆç†èŒƒå›´å†…
          const maxScrollTop = lyricsEl.scrollHeight - containerHeight;
          const adjustedScrollTop = Math.max(0, Math.min(targetScrollTop, maxScrollTop));
          
          // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
          lyricsEl.scrollTo({
            top: adjustedScrollTop,
            behavior: 'smooth'
          });
        }
      };

      // ä¿å­˜å¤„ç†å‡½æ•°å¼•ç”¨
      audio.lyricsScrollHandler = () => highlight(audio.currentTime);
      
      // ç›‘å¬éŸ³é¢‘æ—¶é—´æ›´æ–°
      audio.addEventListener("timeupdate", audio.lyricsScrollHandler);
      
      // åˆå§‹é«˜äº®
      highlight(0);
    }

    // åˆ‡æ¢æ’­æ”¾/æš‚åœ
    async function togglePlay() {
      if (!audio) {
        console.error('éŸ³é¢‘å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      // å¦‚æœéŸ³é¢‘æºæœªè®¾ç½®ï¼Œå…ˆåŠ è½½æ­Œæ›²
      if (!audio.src || audio.src === window.location.href) {
        console.log('éŸ³é¢‘æºæœªè®¾ç½®ï¼Œå…ˆåŠ è½½æ­Œæ›²');
        try {
          await loadAndPlaySong();
          // ç­‰å¾…éŸ³é¢‘åŠ è½½å®Œæˆ
          if (audio.readyState === 0) {
            await new Promise((resolve, reject) => {
              const onCanPlay = () => {
                audio.removeEventListener('canplay', onCanPlay);
                audio.removeEventListener('error', onError);
                resolve();
              };
              const onError = (e) => {
                audio.removeEventListener('canplay', onCanPlay);
                audio.removeEventListener('error', onError);
                reject(e);
              };
              audio.addEventListener('canplay', onCanPlay);
              audio.addEventListener('error', onError);
            });
          }
        } catch (error) {
          console.error('åŠ è½½æ­Œæ›²å¤±è´¥:', error);
          alert('æ— æ³•åŠ è½½æ­Œæ›²ï¼Œè¯·æ£€æŸ¥æ­Œæ›²æ˜¯å¦å­˜åœ¨');
          return;
        }
      }

      try {
        if (audio.paused) {
          await audio.play();
          updatePlayButton(true);
          startDiscRotation();
          console.log('å¼€å§‹æ’­æ”¾');
        } else {
          audio.pause();
          updatePlayButton(false);
          stopDiscRotation();
          console.log('æš‚åœæ’­æ”¾');
        }
      } catch (error) {
        console.error('æ’­æ”¾æ§åˆ¶å¤±è´¥:', error);
        if (error.name === 'NotAllowedError') {
          alert('æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ‰‹åŠ¨æ’­æ”¾');
        } else {
          alert('æ’­æ”¾å¤±è´¥ï¼š' + error.message);
        }
      }
    }

    // å¼€å§‹å”±ç‰‡æ—‹è½¬
    function startDiscRotation() {
      const discCover = document.querySelector('.disc-cover');
      if (discCover) {
        discCover.classList.add('rotating');
      }
    }

    // åœæ­¢å”±ç‰‡æ—‹è½¬
    function stopDiscRotation() {
      const discCover = document.querySelector('.disc-cover');
      if (discCover) {
        discCover.classList.remove('rotating');
      }
    }

    // æ›´æ–°æ’­æ”¾æŒ‰é’®çŠ¶æ€
    function updatePlayButton(playing) {
      const playBtn = document.getElementById('playBtn');
      const toggleBtn = document.getElementById('toggleBtn');
      
      if (playBtn) {
        playBtn.textContent = playing ? 'æš‚åœ' : 'æ’­æ”¾';
      }
      
      if (toggleBtn) {
        toggleBtn.textContent = playing ? 'â¸' : 'â¯';
      }
    }

    // æ’­æ”¾ä¸Šä¸€é¦–
    function playPrevious() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
      console.log('æ’­æ”¾ä¸Šä¸€é¦–');
    }

    // æ’­æ”¾ä¸‹ä¸€é¦–
    function playNext() {
      // è¿™é‡Œå¯ä»¥æ·»åŠ æ’­æ”¾åˆ—è¡¨åŠŸèƒ½
      console.log('æ’­æ”¾ä¸‹ä¸€é¦–');
    }

    // è·³è½¬æ’­æ”¾è¿›åº¦
    function seekAudio() {
      const progress = document.getElementById('progress');
      if (audio && progress) {
        const seekTime = (audio.duration * progress.value) / 100;
        audio.currentTime = seekTime;
      }
    }

    // è®¾ç½®éŸ³é‡
    function setVolume() {
      const volume = document.getElementById('volume');
      if (audio && volume) {
        audio.volume = volume.value / 100;
      }
    }

    // æ›´æ–°æ’­æ”¾è¿›åº¦
    function updateProgress() {
      const progress = document.getElementById('progress');
      const curTime = document.getElementById('curTime');
      const durTime = document.getElementById('durTime');
      
      if (audio && progress && curTime && durTime) {
        const progressValue = (audio.currentTime / audio.duration) * 100 || 0;
        progress.value = progressValue;
        
        curTime.textContent = formatTime(audio.currentTime);
        durTime.textContent = formatTime(audio.duration);
      }
    }

    // æ›´æ–°æ€»æ—¶é•¿
    function updateDuration() {
      const durTime = document.getElementById('durTime');
      if (audio && durTime) {
        durTime.textContent = formatTime(audio.duration);
      }
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';
      
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // ä»æœ¬åœ°éŸ³ä¹åº“è·å–æ­Œæ›²å®Œæ•´ä¿¡æ¯
    async function fetchSongInfo(songId) {
      try {
        console.log('å¼€å§‹è·å–æ­Œæ›²ä¿¡æ¯ï¼ŒID:', songId);
        const response = await fetch(`/api/track?id=${songId}`);
        if (response.ok) {
          const songInfo = await response.json();
          console.log('è·å–åˆ°çš„æ­Œæ›²ä¿¡æ¯:', songInfo);
          currentSongTitle = songInfo.title || currentSongTitle;
          currentSongArtist = songInfo.artist || currentSongArtist;
          currentSongAlbum = songInfo.album || currentSongAlbum;
          
          // æ›´æ–°é¡µé¢ä¿¡æ¯
          updatePageInfo();
          // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæ”¶è—çŠ¶æ€
          await checkFavoriteStatus();
          // åŠ è½½æ­Œæ›²ï¼ˆä¸è‡ªåŠ¨æ’­æ”¾ï¼‰
          await loadAndPlaySong();
        } else {
          console.error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
          const errorText = await response.text();
          throw new Error(`APIè¿”å›é”™è¯¯: ${response.status} - ${errorText}`);
        }
      } catch (error) {
        console.error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:', error);
        // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•ä½¿ç”¨å·²æœ‰ä¿¡æ¯åŠ è½½æ­Œæ›²
        updatePageInfo();
        await checkFavoriteStatus();
        try {
          await loadAndPlaySong();
        } catch (loadError) {
          console.error('åŠ è½½æ­Œæ›²å¤±è´¥:', loadError);
          // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
          const errorMsg = loadError.message || 'æ— æ³•åŠ è½½æ­Œæ›²ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•';
          console.error('é”™è¯¯è¯¦æƒ…:', errorMsg);
        }
      }
    }

    // æ›´æ–°é¡µé¢ä¿¡æ¯
    function updatePageInfo() {
      if (currentSongTitle) {
        document.querySelector('h1').textContent = currentSongTitle;
        document.querySelector('.artist').textContent = 'æ­Œæ‰‹ï¼š' + (currentSongArtist || 'æœªçŸ¥æ­Œæ‰‹');
        document.querySelector('.album').textContent = 'æ‰€å±ä¸“è¾‘ï¼š' + (currentSongAlbum || 'æœªçŸ¥ä¸“è¾‘');
      }
    }

    // æ£€æŸ¥æ”¶è—çŠ¶æ€
    async function checkFavoriteStatus() {
      if (!currentSongId) {
        updateFavoriteButton(false);
        return;
      }

      try {
        // å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        const authResponse = await fetch('/api/check_auth');
        if (!authResponse.ok) {
          updateFavoriteButton(false);
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.authenticated) {
          updateFavoriteButton(false);
          return;
        }

        // ç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥æ”¶è—çŠ¶æ€
        const response = await fetch(`/api/favorites/check?song_id=${currentSongId}`);
        if (response.ok) {
          const result = await response.json();
          isFavorited = result.isFavorited;
          updateFavoriteButton(isFavorited);
        }
      } catch (error) {
        console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€æ—¶å‡ºé”™:', error);
        updateFavoriteButton(false);
      }
    }

    // åˆ‡æ¢æ”¶è—çŠ¶æ€
    async function toggleFavorite() {
      if (!currentSongId || !currentSongTitle || !currentSongArtist) {
        alert('æ­Œæ›²ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•æ”¶è—');
        return;
      }

      try {
        // å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        const authResponse = await fetch('/api/check_auth');
        if (!authResponse.ok) {
          alert('è¯·å…ˆç™»å½•åå†æ”¶è—æ­Œæ›²');
          document.getElementById('loginModal').classList.remove('hidden');
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.authenticated) {
          alert('è¯·å…ˆç™»å½•åå†æ”¶è—æ­Œæ›²');
          document.getElementById('loginModal').classList.remove('hidden');
          return;
        }

        if (isFavorited) {
          // å–æ¶ˆæ”¶è—
          const response = await fetch(`/api/favorites/${currentSongId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            isFavorited = false;
            updateFavoriteButton(false);
            alert('å·²å–æ¶ˆæ”¶è—');
          } else {
            alert('å–æ¶ˆæ”¶è—å¤±è´¥');
          }
        } else {
          // æ·»åŠ æ”¶è— - åªå­˜å‚¨å¿…è¦çš„æ­Œæ›²ä¿¡æ¯
          const response = await fetch('/api/favorites', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              song_id: currentSongId,
              song_title: currentSongTitle,
              song_artist: currentSongArtist,
              song_album: currentSongAlbum || ''
            })
          });

          if (response.ok) {
            isFavorited = true;
            updateFavoriteButton(true);
            alert('æ”¶è—æˆåŠŸï¼');
          } else {
            alert('æ”¶è—å¤±è´¥');
          }
        }
      } catch (error) {
        console.error('æ”¶è—æ“ä½œæ—¶å‡ºé”™:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
    function updateFavoriteButton(favorited) {
      const favoriteBtn = document.getElementById('favoriteBtn');
      if (favoriteBtn) {
        if (favorited) {
          favoriteBtn.innerHTML = 'â¤ å·²æ”¶è—';
          favoriteBtn.style.background = 'var(--primary)';
          favoriteBtn.style.color = '#fff';
        } else {
          favoriteBtn.innerHTML = 'â¤ æ”¶è—';
          favoriteBtn.style.background = '';
          favoriteBtn.style.color = '';
        }
      }
    }

    // è®¾ç½®æ­Œè¯åˆ†é¡µåŠŸèƒ½
    function setupLyricsPagination(totalPages) {
      if (totalPages <= 1) return;
      
      let currentPage = 0;
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const pageInfo = document.getElementById('pageInfo');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (currentPage > 0) {
            currentPage--;
            updateLyricsPage(currentPage, totalPages);
          }
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages - 1) {
            currentPage++;
            updateLyricsPage(currentPage, totalPages);
          }
        });
      }
      
      // åˆå§‹çŠ¶æ€
      updateLyricsPage(currentPage, totalPages);
    }
    
    // æ›´æ–°æ­Œè¯é¡µé¢æ˜¾ç¤º
    function updateLyricsPage(page, totalPages) {
      const pages = document.querySelectorAll('.lyrics-page');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const pageInfo = document.getElementById('pageInfo');
      
      // éšè—æ‰€æœ‰é¡µé¢
      pages.forEach(p => p.classList.remove('active'));
      
      // æ˜¾ç¤ºå½“å‰é¡µé¢
      const currentPage = document.querySelector(`.lyrics-page[data-page="${page}"]`);
      if (currentPage) {
        currentPage.classList.add('active');
      }
      
      // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
      if (prevBtn) prevBtn.disabled = page === 0;
      if (nextBtn) nextBtn.disabled = page === totalPages - 1;
      if (pageInfo) pageInfo.textContent = `${page + 1}/${totalPages}`;
    }

    // å…¨å±€å‡½æ•°ï¼šæ›´æ–°æ”¶è—çŠ¶æ€ï¼ˆä¾›æ”¶è—é¡µé¢è°ƒç”¨ï¼‰
    window.updateSongFavoriteStatus = function(songId, favorited) {
      if (songId === currentSongId) {
        isFavorited = favorited;
        updateFavoriteButton(favorited);
      }
    };

    // åˆå§‹åŒ–è¯„è®ºåŠŸèƒ½ï¼ˆä¸ä¾èµ– app.jsï¼‰
    function initComments() {
      if (!currentSongId) return;

      const loginStatus = document.getElementById('loginStatus');
      const commentForm = document.getElementById('commentForm');
      const commentInput = document.getElementById('commentInput');
      const submitComment = document.getElementById('submitComment');
      const commentsList = document.getElementById('commentsList');
      const goToLogin = document.getElementById('goToLogin');

      if (!loginStatus || !commentForm || !commentInput || !submitComment || !commentsList) {
        console.warn('è¯„è®ºç›¸å…³å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
      async function checkAuthStatus() {
        try {
          const response = await fetch('/api/check_auth');
          if (!response.ok) {
            throw new Error('HTTP error: ' + response.status);
          }
          const data = await response.json();
          
          if (data.authenticated) {
            // ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºè¯„è®ºè¡¨å•
            loginStatus.classList.add('hidden');
            commentForm.classList.remove('hidden');
          } else {
            // ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æç¤º
            loginStatus.classList.remove('hidden');
            commentForm.classList.add('hidden');
          }
        } catch (error) {
          console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
          // é»˜è®¤æ˜¾ç¤ºç™»å½•æç¤º
          loginStatus.classList.remove('hidden');
          commentForm.classList.add('hidden');
        }
      }
      
      // åŠ è½½è¯„è®º
      async function loadComments() {
        try {
          const response = await fetch(`/api/comments?song_id=${currentSongId}`);
          if (!response.ok) {
            throw new Error('åŠ è½½è¯„è®ºå¤±è´¥: ' + response.status);
          }
          const comments = await response.json();
          
          if (Array.isArray(comments) && comments.length > 0) {
            renderComments(comments);
          } else {
            commentsList.innerHTML = '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>';
          }
        } catch (error) {
          console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
          commentsList.innerHTML = '<div class="no-comments">åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
        }
      }
      
      // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
      function renderComments(comments) {
        commentsList.innerHTML = '';
        
        comments.forEach(comment => {
          const commentElement = document.createElement('div');
          commentElement.className = 'comment-item';
          
          // ä½¿ç”¨åç«¯è¿”å›çš„ç”¨æˆ·æ˜µç§°
          const userNickname = comment.nickname || comment.username || 'ç”¨æˆ·';
          
          // å®‰å…¨å¤„ç†æ—¥æœŸ
          let commentTime = 'æœªçŸ¥æ—¶é—´';
          try {
            if (comment.created_at) {
              commentTime = new Date(comment.created_at).toLocaleString('zh-CN');
            }
          } catch (error) {
            console.error('æ—¥æœŸè§£æé”™è¯¯:', error);
            commentTime = comment.created_at || 'æœªçŸ¥æ—¶é—´';
          }
          
          // è·å–è¯„è®ºå†…å®¹å¹¶è½¬ä¹‰HTML
          const content = escapeHtml(comment.content || 'æ— å†…å®¹');
          
          commentElement.innerHTML = `
            <div class="comment-header">
              <span class="comment-user">${escapeHtml(userNickname)}</span>
              <span class="comment-time">${escapeHtml(commentTime)}</span>
            </div>
            <div class="comment-content">${content}</div>
          `;
          
          commentsList.appendChild(commentElement);
        });
      }
      
      // HTMLè½¬ä¹‰å‡½æ•°
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      // æäº¤è¯„è®º
      async function handleSubmitComment() {
        const content = commentInput.value.trim();
        
        if (!content) {
          alert('è¯·è¾“å…¥è¯„è®ºå†…å®¹');
          return;
        }
        
        if (content.length > 500) {
          alert('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡500å­—');
          return;
        }
        
        submitComment.disabled = true;
        submitComment.textContent = 'å‘è¡¨ä¸­...';
        
        try {
          const response = await fetch('/api/comments', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              song_id: parseInt(currentSongId),
              content: content
            })
          });
          
          if (response.ok) {
            commentInput.value = '';
            await loadComments(); // é‡æ–°åŠ è½½è¯„è®ºåˆ—è¡¨
            alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
          } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'å‘è¡¨è¯„è®ºå¤±è´¥');
          }
        } catch (error) {
          console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
          alert('å‘è¡¨è¯„è®ºå¤±è´¥ï¼š' + error.message);
        } finally {
          submitComment.disabled = false;
          submitComment.textContent = 'å‘è¡¨è¯„è®º';
        }
      }
      
      // äº‹ä»¶ç›‘å¬
      submitComment.addEventListener('click', handleSubmitComment);
      
      commentInput.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
          handleSubmitComment();
        }
      });
      
      if (goToLogin) {
        goToLogin.addEventListener('click', (e) => {
          e.preventDefault();
          // ç›´æ¥æ‰“å¼€ç™»å½•æ¨¡æ€æ¡†
          const loginModal = document.getElementById('loginModal');
          const modalOverlay = document.getElementById('modalOverlay');
          if (loginModal && modalOverlay) {
            modalOverlay.classList.remove('hidden');
            loginModal.classList.remove('hidden');
          }
        });
      }
      
      // åˆå§‹åŒ–
      checkAuthStatus();
      loadComments();
    }

    // è¯„è®ºåŠŸèƒ½ä¼šåœ¨ DOMContentLoaded äº‹ä»¶ä¸­çš„ fetchSongInfo ä¹‹åè°ƒç”¨
    
    // åˆå§‹åŒ–ç™»å½•çŠ¶æ€ç®¡ç†
    if (window.authManager) {
      window.authManager.initAllPagesAuth();
    }
  </script>
</body>
</html>