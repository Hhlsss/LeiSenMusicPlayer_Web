<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ­Œæ›²è¯¦æƒ…</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">é›·æ£®éŸ³ä¹</div>
    <nav class="nav">
      <a href="/">æˆ‘çš„éŸ³ä¹</a>
      <a href="/artists">æ­Œæ‰‹</a>
      <a href="/albums">ä¸“è¾‘</a>
      <a href="/favorites">æˆ‘çš„æ”¶è—</a>
      <a href="/profile">ä¸ªäººä¸­å¿ƒ</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="æœç´¢æ­Œæ›²/æ­Œæ‰‹/ä¸“è¾‘" />
    </div>
    <div class="user-actions">
      <button class="primary">åˆ›å»ºæ­Œå•</button>
      <button id="loginOpen">ç™»å½•</button>
      <button id="registerOpen">æ³¨å†Œ</button>
      <button id="logoutBtn" class="hidden">é€€å‡º</button>
      <span id="userNickname" class="hidden nickname"></span>
    </div>
  </header>

  <main class="song-page">
    <section class="song-info">
      <div class="disc">
        <div class="disc-cover" style="background-image:url('https://picsum.photos/id/1062/300/300');"></div>
      </div>
      <div class="meta">
        <h1></h1>
        <div class="tags">
          <span class="tag">VIPå•æ›²</span>
          <span class="tag">æ—¥è¯­</span>
        </div>
        <p class="artist">æ­Œæ‰‹ï¼šVaundy</p>
        <p class="album">æ‰€å±ä¸“è¾‘ï¼šreplica</p>

        <div class="actions">
          <button class="primary" id="playBtn">æ’­æ”¾</button>
          <button id="favoriteBtn" class="favorite-btn">â¤ æ”¶è—</button>
          <button>åˆ†äº«</button>
          <button>ä¸‹è½½</button>
        </div>

        <article class="lyrics">
          <h3>æ­Œè¯æ‘˜é€‰</h3>
          <p>ã­ã‡ ã©ã“ã‹ã«ç½®ã„ã¦ããŸã‚ˆã†ãª å¤¢ã‚’å›ã®æ¨ªé¡”ã«é‡ã­ã¦â€¦ï¼ˆç¤ºä¾‹ï¼‰</p>
        </article>
      </div>

      <aside class="related">
        <!-- <h3>åŒ…å«è¿™é¦–æ­Œçš„æ­Œå•</h3>
        <ul>
          <li>æµè¡Œç²¾é€‰ Â· æ¯æ—¥æ¨è</li>
          <li>å¤æ—¥ç”µéŸ³ Â· æ´¾å¯¹ç²¾é€‰</li>
          <li>æ‘‡æ»šçƒ­æ½® Â· ä¹é˜Ÿåˆè¾‘</li>
        </ul> -->
      </aside>
    </section>

    <!-- è¯„è®ºåŒºåŸŸ -->
    <section class="comments-section">
      <h2>è¯„è®º</h2>
      
      <!-- ç™»å½•çŠ¶æ€æ£€æŸ¥ -->
      <div id="loginStatus" class="login-status hidden">
        <p>ä½ è¿˜æœªç™»å½•ï¼Œè¯·<a href="/" id="goToLogin">ç™»å½•</a>åå‘è¡¨è¯„è®º</p>
      </div>

      <!-- è¯„è®ºè¡¨å• -->
      <div id="commentForm" class="comment-form hidden">
        <div class="comment-input-container">
          <textarea id="commentInput" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..." rows="3"></textarea>
          <button id="submitComment" class="primary">å‘è¡¨è¯„è®º</button>
        </div>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div id="commentsList" class="comments-list">
        <div class="loading">åŠ è½½è¯„è®ºä¸­...</div>
      </div>
    </section>
    </section>
  </main>

  <!-- åº•éƒ¨æ’­æ”¾å™¨æ  -->
  <div class="player-bar">
    <div class="player-left">
      <img class="mini-cover" src="https://picsum.photos/id/1062/60/60" alt="cover" />
      <div class="track">
        <div class="title"></div>
        <div class="artist">Vaundy</div>
      </div>
    </div>
    <div class="player-center">
      <button id="prevBtn">â®</button>
      <button id="toggleBtn">â¯</button>
      <button id="nextBtn">â­</button>
    </div>
    <div class="player-right">
      <div class="time">
        <span id="curTime">00:00</span> / <span id="durTime">00:00</span>
      </div>
      <input id="progress" type="range" min="0" max="100" value="0" />
      <div class="volume-container">
        <span class="volume-icon" id="volumeIcon">ğŸ”Š</span>
        <input id="volume" type="range" min="0" max="100" value="80" />
      </div>
    </div>
    <audio id="audio" preload="metadata" src="https://www2.cs.uic.edu/~i101/SoundFiles/StarWars3.wav"></audio>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__SUPABASE_URL__ = window.__SUPABASE_URL__ || 'https://gblnpzstdjnvclijjpbk.supabase.co';
    window.__SUPABASE_ANON_KEY__ = window.__SUPABASE_ANON_KEY__ || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdibG5wenN0ZGpudmNsaWpqcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjgzNjEsImV4cCI6MjA3NjA0NDM2MX0.YaMwiKVVUgToza4vMtBjHAgvE28fdWTqtNHHtI9peFU';
  </script>
  <script src="/static/app.js"></script>
  <script>
    // æ­Œæ›²é¡µé¢æ”¶è—åŠŸèƒ½
    let currentSongId = '';
    let currentSongTitle = '';
    let currentSongArtist = '';
    let currentSongAlbum = '';
    let isFavorited = false;

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // è·å–URLå‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      currentSongId = urlParams.get('id') || '';
      currentSongTitle = urlParams.get('song') || '';
      currentSongArtist = urlParams.get('artist') || '';
      currentSongAlbum = urlParams.get('album') || '';

      // å¦‚æœURLå‚æ•°ä¸­ç¼ºå°‘æ­Œæ›²ä¿¡æ¯ï¼Œå°è¯•ä»æœ¬åœ°éŸ³ä¹åº“è·å–å®Œæ•´ä¿¡æ¯
      if (currentSongId && (!currentSongTitle || !currentSongArtist)) {
        fetchSongInfo(currentSongId);
      } else {
        // æ›´æ–°é¡µé¢ä¿¡æ¯
        updatePageInfo();
        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæ”¶è—çŠ¶æ€
        checkFavoriteStatus();
      }

      // è®¾ç½®æ”¶è—æŒ‰é’®äº‹ä»¶
      const favoriteBtn = document.getElementById('favoriteBtn');
      if (favoriteBtn) {
        favoriteBtn.addEventListener('click', toggleFavorite);
      }
    });

    // ä»æœ¬åœ°éŸ³ä¹åº“è·å–æ­Œæ›²å®Œæ•´ä¿¡æ¯
    async function fetchSongInfo(songId) {
      try {
        const response = await fetch(`/api/song_info?id=${songId}`);
        if (response.ok) {
          const songInfo = await response.json();
          currentSongTitle = songInfo.title || currentSongTitle;
          currentSongArtist = songInfo.artist || currentSongArtist;
          currentSongAlbum = songInfo.album || currentSongAlbum;
        }
      } catch (error) {
        console.error('è·å–æ­Œæ›²ä¿¡æ¯å¤±è´¥:', error);
      } finally {
        // æ›´æ–°é¡µé¢ä¿¡æ¯
        updatePageInfo();
        // æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæ”¶è—çŠ¶æ€
        checkFavoriteStatus();
      }
    }

    // æ›´æ–°é¡µé¢ä¿¡æ¯
    function updatePageInfo() {
      if (currentSongTitle) {
        document.querySelector('h1').textContent = currentSongTitle;
        document.querySelector('.artist').textContent = 'æ­Œæ‰‹ï¼š' + (currentSongArtist || 'æœªçŸ¥æ­Œæ‰‹');
        document.querySelector('.album').textContent = 'æ‰€å±ä¸“è¾‘ï¼š' + (currentSongAlbum || 'æœªçŸ¥ä¸“è¾‘');
      }
    }

    // æ£€æŸ¥æ”¶è—çŠ¶æ€
    async function checkFavoriteStatus() {
      if (!currentSongId) {
        updateFavoriteButton(false);
        return;
      }

      try {
        // å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        const authResponse = await fetch('/api/check_auth');
        if (!authResponse.ok) {
          updateFavoriteButton(false);
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.authenticated) {
          updateFavoriteButton(false);
          return;
        }

        // ç”¨æˆ·å·²ç™»å½•ï¼Œæ£€æŸ¥æ”¶è—çŠ¶æ€
        const response = await fetch(`/api/favorites/check?song_id=${currentSongId}`);
        if (response.ok) {
          const result = await response.json();
          isFavorited = result.isFavorited;
          updateFavoriteButton(isFavorited);
        }
      } catch (error) {
        console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€æ—¶å‡ºé”™:', error);
        updateFavoriteButton(false);
      }
    }

    // åˆ‡æ¢æ”¶è—çŠ¶æ€
    async function toggleFavorite() {
      if (!currentSongId || !currentSongTitle || !currentSongArtist) {
        alert('æ­Œæ›²ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•æ”¶è—');
        return;
      }

      try {
        // å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        const authResponse = await fetch('/api/check_auth');
        if (!authResponse.ok) {
          alert('è¯·å…ˆç™»å½•åå†æ”¶è—æ­Œæ›²');
          document.getElementById('loginModal').classList.remove('hidden');
          return;
        }
        
        const authData = await authResponse.json();
        if (!authData.authenticated) {
          alert('è¯·å…ˆç™»å½•åå†æ”¶è—æ­Œæ›²');
          document.getElementById('loginModal').classList.remove('hidden');
          return;
        }

        if (isFavorited) {
          // å–æ¶ˆæ”¶è—
          const response = await fetch(`/api/favorites/${currentSongId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            isFavorited = false;
            updateFavoriteButton(false);
            alert('å·²å–æ¶ˆæ”¶è—');
          } else {
            alert('å–æ¶ˆæ”¶è—å¤±è´¥');
          }
        } else {
          // æ·»åŠ æ”¶è— - åªå­˜å‚¨å¿…è¦çš„æ­Œæ›²ä¿¡æ¯
          const response = await fetch('/api/favorites', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              song_id: currentSongId,
              song_title: currentSongTitle,
              song_artist: currentSongArtist,
              song_album: currentSongAlbum || ''
            })
          });

          if (response.ok) {
            isFavorited = true;
            updateFavoriteButton(true);
            alert('æ”¶è—æˆåŠŸï¼');
          } else {
            alert('æ”¶è—å¤±è´¥');
          }
        }
      } catch (error) {
        console.error('æ”¶è—æ“ä½œæ—¶å‡ºé”™:', error);
        alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
    function updateFavoriteButton(favorited) {
      const favoriteBtn = document.getElementById('favoriteBtn');
      if (favoriteBtn) {
        if (favorited) {
          favoriteBtn.innerHTML = 'â¤ å·²æ”¶è—';
          favoriteBtn.style.background = 'var(--primary)';
          favoriteBtn.style.color = '#fff';
        } else {
          favoriteBtn.innerHTML = 'â¤ æ”¶è—';
          favoriteBtn.style.background = '';
          favoriteBtn.style.color = '';
        }
      }
    }

    // å…¨å±€å‡½æ•°ï¼šæ›´æ–°æ”¶è—çŠ¶æ€ï¼ˆä¾›æ”¶è—é¡µé¢è°ƒç”¨ï¼‰
    window.updateSongFavoriteStatus = function(songId, favorited) {
      if (songId === currentSongId) {
        isFavorited = favorited;
        updateFavoriteButton(favorited);
      }
    };
    
    // åˆå§‹åŒ–ç™»å½•çŠ¶æ€ç®¡ç†
    if (window.authManager) {
      window.authManager.initAllPagesAuth();
    }
  </script>
</body>
</html>