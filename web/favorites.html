<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘çš„æ”¶è— - é›·æ£®éŸ³ä¹</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="logo">é›·æ£®éŸ³ä¹</div>
    <nav class="nav">
      <a href="/">æˆ‘çš„éŸ³ä¹</a>
      <a href="/artists">æ­Œæ‰‹</a>
      <a href="/albums">ä¸“è¾‘</a>
      <a href="/favorites" class="active">æˆ‘çš„æ”¶è—</a>
      <a href="/upload">ä¸Šä¼ </a>
      <a href="/forum">éŸ³ä¹è®ºå›</a>
      <a href="/profile">ä¸ªäººä¸­å¿ƒ</a>
    </nav>
    <div class="search">
      <input type="text" placeholder="æœç´¢æ­Œæ›²/æ­Œæ‰‹/ä¸“è¾‘" />
    </div>
    <div class="user-actions">
      <button class="primary">åˆ›å»ºæ­Œå•</button>
      <button id="logoutBtn" class="hidden">é€€å‡º</button>
      <span id="userNickname" class="hidden nickname"></span>
    </div>
  </header>

  <main class="content">
    <div class="section-header">
      <h2>æˆ‘çš„æ”¶è—</h2>
      <div class="tabs">
        <a href="#" class="active">æ­Œæ›²</a>
        <a href="#">ä¸“è¾‘</a>
        <a href="#">æ­Œæ‰‹</a>
      </div>
    </div>

    <!-- ç™»å½•æç¤º -->
    <div id="loginPrompt" class="login-status" style="display: none;">
      <p>è¯·å…ˆ<a href="#" id="loginPromptLink">ç™»å½•</a>æŸ¥çœ‹æ‚¨çš„æ”¶è—æ­Œæ›²</p>
    </div>

    <!-- æ”¶è—æ­Œæ›²åˆ—è¡¨ -->
    <div id="favoritesContainer" style="display: none;">
      <div class="songs-container">
        <div class="song-item header">
          <div class="song-index">#</div>
          <div class="song-info">æ­Œæ›²æ ‡é¢˜</div>
          <div class="song-album">ä¸“è¾‘</div>
          <div class="song-actions">æ“ä½œ</div>
        </div>
        <div id="favoritesList">
          <!-- æ”¶è—æ­Œæ›²å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
      </div>
      
      <!-- ç©ºçŠ¶æ€ -->
      <div id="emptyFavorites" class="no-results" style="display: none;">
        <h3>æš‚æ— æ”¶è—æ­Œæ›²</h3>
        <p>æ‚¨è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ­Œæ›²ï¼Œå¿«å»å‘ç°å¥½å¬çš„éŸ³ä¹å§ï¼</p>
      </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div id="loadingFavorites" class="loading">
      <p>æ­£åœ¨åŠ è½½æ”¶è—æ­Œæ›²...</p>
    </div>
  </main>

  <!-- åº•éƒ¨æ’­æ”¾å™¨ -->
  <div class="player-bar">
    <div class="player-left">
      <img id="miniCover" class="mini-cover" src="" alt="å°é¢" />
      <div class="track">
        <div class="title" id="currentTitle">æœªæ’­æ”¾</div>
        <div class="artist" id="currentArtist">-</div>
      </div>
    </div>
    <div class="player-center">
      <button id="prevBtn">â®</button>
      <button id="toggleBtn">â–¶</button>
      <button id="nextBtn">â­</button>
    </div>
    <div class="player-right">
      <div class="time">
        <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
      </div>
      <input type="range" id="progress" min="0" max="100" value="0" />
      <div class="volume-container">
        <span class="volume-icon">ğŸ”Š</span>
        <input type="range" id="volume" min="0" max="100" value="50" />
      </div>
    </div>
  </div>

  <!-- ç™»å½•/æ³¨å†Œæ¨¡æ€æ¡† -->
  <div id="modalOverlay" class="modal-overlay hidden"></div>

  <div id="loginModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <div class="modal-header">
      <span id="loginTitle">ç™»å½•</span>
      <button class="modal-close" aria-label="å…³é—­ç™»å½•çª—å£">&times;</button>
    </div>
    <div class="modal-body">
      <form id="loginForm">
        <div class="form-row">
          <label for="loginAccount">é‚®ç®±</label>
          <input type="text" id="loginAccount" placeholder="è¯·è¾“å…¥é‚®ç®±" required />
        </div>
        <div class="form-row">
          <label for="loginPassword">å¯†ç </label>
          <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </div>
        <button type="submit" class="btn-gradient full">ç™»å½•</button>
      </form>
    </div>
  </div>

  <div id="registerModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="registerTitle">
    <div class="modal-header">
      <span id="registerTitle">æ³¨å†Œ</span>
      <button class="modal-close" aria-label="å…³é—­æ³¨å†Œçª—å£">&times;</button>
    </div>
    <div class="modal-body">
      <form id="registerForm">
        <div class="form-row">
          <label for="registerAccount">é‚®ç®±</label>
          <input type="text" id="registerAccount" placeholder="è¯·è¾“å…¥é‚®ç®±" required />
        </div>
        <div class="form-row">
          <label for="registerPassword">å¯†ç </label>
          <input type="password" id="registerPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
        </div>
        <button type="submit" class="btn-gradient full">æ³¨å†Œ</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__SUPABASE_URL__ = window.__SUPABASE_URL__ || 'https://gblnpzstdjnvclijjpbk.supabase.co';
    window.__SUPABASE_ANON_KEY__ = window.__SUPABASE_ANON_KEY__ || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdibG5wenN0ZGpudmNsaWpqcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjgzNjEsImV4cCI6MjA3NjA0NDM2MX0.YaMwiKVVUgToza4vMtBjHAgvE28fdWTqtNHHtI9peFU';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.__SUPABASE_URL__ = window.__SUPABASE_URL__ || 'https://gblnpzstdjnvclijjpbk.supabase.co';
    window.__SUPABASE_ANON_KEY__ = window.__SUPABASE_ANON_KEY__ || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdibG5wenN0ZGpudmNsaWpqcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjgzNjEsImV4cCI6MjA3NjA0NDM2MX0.YaMwiKVVUgToza4vMtBjHAgvE28fdWTqtNHHtI9peFU';
  </script>
  <script src="app.js"></script>
  <script>
    // æ”¶è—é¡µé¢ç‰¹å®šåŠŸèƒ½
    let currentUser = null;
    let favorites = [];

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkLoginStatus() {
      try {
        const response = await fetch('/api/check_auth');
        if (response.ok) {
          const data = await response.json();
          if (data.authenticated) {
            // ç”¨æˆ·å·²ç™»å½•
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('favoritesContainer').style.display = 'block';
            document.getElementById('loadingFavorites').style.display = 'none';
            
            // æ›´æ–°å¯¼èˆªæ ç™»å½•çŠ¶æ€
            updateNavbarLoginStatus(true);
            
            loadFavorites();
          } else {
            // ç”¨æˆ·æœªç™»å½•
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('favoritesContainer').style.display = 'none';
            document.getElementById('loadingFavorites').style.display = 'none';
            
            // æ›´æ–°å¯¼èˆªæ ç™»å½•çŠ¶æ€
            updateNavbarLoginStatus(false);
          }
        } else {
          throw new Error('è®¤è¯æ£€æŸ¥å¤±è´¥');
        }
      } catch (error) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        // é»˜è®¤æ˜¾ç¤ºç™»å½•æç¤º
        document.getElementById('loginPrompt').style.display = 'block';
        document.getElementById('favoritesContainer').style.display = 'none';
        document.getElementById('loadingFavorites').style.display = 'none';
        
        updateNavbarLoginStatus(false);
      }
    }

    // æ›´æ–°å¯¼èˆªæ ç™»å½•çŠ¶æ€ï¼ˆä½¿ç”¨å…¨å±€ç™»å½•çŠ¶æ€ç®¡ç†ï¼‰
    function updateNavbarLoginStatus(isLoggedIn) {
      if (window.authManager) {
        window.authManager.updateNavbarStatus(isLoggedIn);
      }
    }

    // åŠ è½½æ”¶è—æ­Œæ›²
    async function loadFavorites() {
      try {
        const response = await fetch('/api/favorites');
        if (response.ok) {
          const favoritesData = await response.json();
          
          // ä¸ºæ¯ä¸ªæ”¶è—çš„æ­Œæ›²è·å–å®Œæ•´ä¿¡æ¯
          favorites = await Promise.all(favoritesData.map(async (fav) => {
            try {
              // å°è¯•ä»æœ¬åœ°éŸ³ä¹åº“è·å–æ­Œæ›²å®Œæ•´ä¿¡æ¯
              const songInfoResponse = await fetch(`/api/song_info?id=${fav.song_id}`);
              if (songInfoResponse.ok) {
                const songInfo = await songInfoResponse.json();
                return {
                  ...fav,
                  id: songInfo.id || parseInt(fav.song_id) || 0,
                  title: songInfo.title || fav.song_title,
                  artist: songInfo.artist || fav.song_artist,
                  album: songInfo.album || fav.song_album,
                  hasCover: songInfo.hasCover || false,
                  hasLyrics: songInfo.hasLyrics || false
                };
              }
            } catch (error) {
              console.error(`è·å–æ­Œæ›² ${fav.song_id} ä¿¡æ¯å¤±è´¥:`, error);
            }
            
            // å¦‚æœæ— æ³•è·å–å®Œæ•´ä¿¡æ¯ï¼Œä½¿ç”¨æ”¶è—ä¸­çš„åŸºæœ¬ä¿¡æ¯
            return {
              ...fav,
              id: parseInt(fav.song_id) || 0,
              title: fav.song_title,
              artist: fav.song_artist,
              album: fav.song_album,
              hasCover: false,
              hasLyrics: false
            };
          }));
          
          renderFavorites();
        } else {
          console.error('åŠ è½½æ”¶è—å¤±è´¥');
        }
      } catch (error) {
        console.error('åŠ è½½æ”¶è—æ—¶å‡ºé”™:', error);
      }
    }

    // æ¸²æŸ“æ”¶è—æ­Œæ›²åˆ—è¡¨
    function renderFavorites() {
      const favoritesList = document.getElementById('favoritesList');
      const emptyFavorites = document.getElementById('emptyFavorites');
      
      if (favorites.length === 0) {
        favoritesList.innerHTML = '';
        emptyFavorites.style.display = 'block';
        return;
      }

      emptyFavorites.style.display = 'none';
      favoritesList.innerHTML = favorites.map((fav, index) => `
        <div class="song-item" data-song-id="${fav.id}">
          <div class="song-index">${index + 1}</div>
          <div class="song-info">
            <div class="song-title">
              <a href="/song?id=${fav.id}&song=${encodeURIComponent(fav.title)}&artist=${encodeURIComponent(fav.artist)}&album=${encodeURIComponent(fav.album || '')}">
                ${fav.title}
              </a>
            </div>
            <div class="song-artist">${fav.artist || 'æœªçŸ¥æ­Œæ‰‹'}</div>
          </div>
          <div class="song-album">${fav.album || 'æœªçŸ¥ä¸“è¾‘'}</div>
          <div class="song-actions">
            <button class="play-btn" onclick="playSong(${fav.id}, '${fav.title}', '${fav.artist}')">æ’­æ”¾</button>
            <button class="collect-btn remove-favorite" onclick="removeFavorite('${fav.song_id}')">å–æ¶ˆæ”¶è—</button>
          </div>
        </div>
      `).join('');
    }

    // å–æ¶ˆæ”¶è—
    async function removeFavorite(songId) {
      if (!confirm('ç¡®å®šè¦å–æ¶ˆæ”¶è—è¿™é¦–æ­Œå—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await fetch(`/api/favorites/${songId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          // ä»æœ¬åœ°åˆ—è¡¨ä¸­ç§»é™¤
          favorites = favorites.filter(fav => fav.song_id !== songId);
          renderFavorites();
          
          // æ›´æ–°æ­Œæ›²é¡µé¢çš„æ”¶è—çŠ¶æ€
          updateFavoriteStatus(songId, false);
        } else {
          alert('å–æ¶ˆæ”¶è—å¤±è´¥');
        }
      } catch (error) {
        console.error('å–æ¶ˆæ”¶è—æ—¶å‡ºé”™:', error);
        alert('å–æ¶ˆæ”¶è—å¤±è´¥');
      }
    }

    // æ’­æ”¾æ­Œæ›²
    function playSong(songId, title, artist) {
      // è¿™é‡Œéœ€è¦å®ç°æ’­æ”¾é€»è¾‘
      console.log('æ’­æ”¾æ­Œæ›²:', songId, title, artist);
      // å¯ä»¥è°ƒç”¨å…¨å±€çš„æ’­æ”¾å™¨åŠŸèƒ½
      if (window.playSongFromId) {
        window.playSongFromId(songId, title, artist);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      checkLoginStatus();
      
      // è®¾ç½®æ¨¡æ€æ¡†äº‹ä»¶
      setupModalEvents();
      
      // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
      window.addEventListener('userLogin', function() {
        checkLoginStatus();
      });
      
      window.addEventListener('userLogout', function() {
        checkLoginStatus();
      });
    });

    // è®¾ç½®æ¨¡æ€æ¡†äº‹ä»¶ - ä½¿ç”¨app.jsä¸­çš„ç»Ÿä¸€é€»è¾‘
    function setupModalEvents() {
      // æ¨¡æ€æ¡†äº‹ä»¶å·²ç»åœ¨app.jsä¸­ç»Ÿä¸€å¤„ç†
      // è¿™é‡Œåªéœ€è¦ç¡®ä¿æ¨¡æ€æ¡†å…ƒç´ å­˜åœ¨å³å¯
      
      // ç™»å½•æç¤ºé“¾æ¥
      document.getElementById('loginPromptLink').addEventListener('click', function(e) {
        e.preventDefault();
        // ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢
        window.location.href = '/login';
      });
    }

    // æ›´æ–°æ­Œæ›²é¡µé¢çš„æ”¶è—çŠ¶æ€ï¼ˆå…¨å±€å‡½æ•°ï¼‰
    function updateFavoriteStatus(songId, isFavorited) {
      // è¿™ä¸ªå‡½æ•°ä¼šè¢«æ­Œæ›²é¡µé¢è°ƒç”¨
      if (window.updateSongFavoriteStatus) {
        window.updateSongFavoriteStatus(songId, isFavorited);
      }
    }
    
    // åˆå§‹åŒ–ç™»å½•çŠ¶æ€ç®¡ç†
    if (window.authManager) {
      window.authManager.initAllPagesAuth();
    }
  </script>
</body>
</html>